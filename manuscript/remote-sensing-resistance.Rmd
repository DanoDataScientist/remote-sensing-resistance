---
output: 
  pdf_document:
  template: "ms_carpentry/mjk_ms_template.tex"
  fig_caption: yes
  # word_document:
  #   fig_width: 8
  #   fig_height: 7
  #   fig_caption: true
  #   df_print: kable
  #   reference_docx: "ms_carpentry/mjk_ms_template_word.docx"
geometry: margin=1in
header-includes: 
- \usepackage{amsmath}
- \usepackage{graphicx}
- \usepackage{setspace}
- \usepackage{mathtools}
- \usepackage[left]{lineno}
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{makecell}
- \usepackage{caption}
- \usepackage{textgreek}
- \linenumbers
- \renewcommand\abstractname{\vspace{-1em}}
# - \captionsetup{width=15cm}

bibliography: "ms_carpentry/remote-sensing-resistance.bib"
csl: https://dl.dropboxusercontent.com/s/3xzxni46ldjzqd1/ecology-letters.csl

title: 'Local variability of vegetation structure increases forest resilience to wildfire'
author:
  - Michael J. Koontz^1,2^, Malcolm P. North^2,3^, Stephen E. Fick^4,5^, Chhaya M. Werner^6^, Andrew M. Latimer^2^

date:
  "^1^Graduate Group in Ecology, University of California, Davis; Davis, CA  \n
  ^2^Department of Plant Sciences, University of California, Davis; Davis, CA  \n
  ^3^Pacific Southwest Research Station, U.S.D.A. Forest Service; Mammoth Lakes, CA  \n
  ^4^U.S. Geological Survey, Southwest Biological Science Center \n
  ^5^Department of Ecology and Evolutionary Biology, University of Colorado, Boulder; Boulder, CO \n
  ^6^Center for Population Biology, University of California, Davis; Davis, CA"

abstract: "The long-term persistence of forest ecosystems hinges on their resilience to ongoing disturbance. Measurements of resilience for these valuable ecosystems are critical, but are challenging to capture at relevant scales given a forest's vast spatial extent and the temporal longevity of its characteristic flora. Wildfire disturbance plays a key role in structuring the vegetation of many forests, and vegetation structure can feedback to influence wildfire behavior. Vegetation structure dictates fuel conditions and high fuel loads paired with hot, dry conditions are known to increase wildfire-induced tree mortality. However, local variability of vegetation structure may enable a forest to withstand wildfire disturbance and retain its fundamental properties and function-- a hallmark of a resilient system. We investigate the system-wide generality of variable forest structure conferring resilience to the yellow pine/mixed-conifer forest of California's Sierra Nevada mountain range. Vegetation structure and disturbance severity can be reliably detected at system-wide spatiotemporal scales using satellite imagery. We use massively parallel cloud computing and texture analysis of Landsat satellite imagery to generate the most comprehensive dataset of wildfire severity and local variability of vegetation structure in this region to date, spanning its entire spatial extent and a 33-year time series of all known wildfires covering greater than 4 hectares. Across the Sierra Nevada range of yellow pine/mixed-conifer, we found that greater variability in local forest structure reduces the probability of a high-severity wildfire. We find the most support for this relationship at the smallest spatial extent of vegetation structure tested (90m x 90m), indicating this phenomenon manifests at a local scale. Variable forest structure thus makes yellow pine/mixed-conifer forest in the Sierra Nevada more resilient to inevitable wildfire disturbance. Management strategies that allow fires to burn under moderate weather and fuel moisture conditions maintain are likely to increase vegetation structure variability in these forests, and may therefore increase the probability of long-term forest persistence."

---
\doublespacing

```{r setup, include=FALSE}
library(here)
library(readr)
library(knitr)
library(kableExtra)
library(captioner)
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

fig_nums <- captioner(prefix = "Fig. ")
table_nums <- captioner(prefix = "Tab. ")
eq_nums <- captioner(prefix = "Eq. ")
```

```{r get_references, results = "hide"}
download.file("https://dl.dropboxusercontent.com/s/2ha48iabtlr5jbo/remote-sensing-resistance.bib", here::here("manuscript/ms_carpentry/remote-sensing-resistance.bib"))
```

```{r source_analyses, results = "hide"}
cbi_models <- read_csv(here::here("data/data_output/cbi_calibration_model_comparison.csv"))

source(here::here("analyses/cbi_summary-stats.R"))
source(here::here("analyses/fire-perims_summary-stats.R"))
source(here::here("analyses/probability-of-high-severity.R"))
source(here::here("analyses/model-comparison.R"))
source(here::here("analyses/prefire-ndvi-neighborhood-mean-ndvi-correlation.R"))

# # This .rds file has the R object name `ss_burned`
# ss_burned <- readRDS(here::here("data/data_output/burned-fire-samples_configured.rds"))
print_cbi_models <- cbi_models
print_cbi_models[, 5:13] <- round(cbi_models[, 5:13], 3)
print_cbi_models <-
  print_cbi_models %>%
  arrange(desc(r2_kfold)) %>%
  mutate(rank = 1:nrow(.)) %>%
  dplyr::select(rank, response, time_window, interpolation, r2_kfold, a, b, c, low_sev, mod_sev, hi_sev)
```

# Introduction

Biological systems comprising heterogeneous elements can retain their fundamental properties in the face of regular disturbance. This ability of a heterogeneous system to absorb disturbances, reorganize, and to persist within a domain of stability with respect to its identity, structure, function, and feedbacks is termed resilience [@Holling1973; @Gunderson2000; @Folke2004; @Walker2004]. Resilience has been demonstrated in complex biological systems characterized by a variety of different types of “heterogeneity” including genetic diversity [@Reusch2005; @Baskett2009; @Agashe2009], species diversity [@Tilman1994; @Chesson2000; @Cadotte2013], functional diversity [@Gazol2016], topoclimatic complexity [@Ackerly2010; @Lenoir2013], and temporal environmental variation [@Questad2008]. An emerging paradigm in forest ecology is that spatial variability in the structure of vegetation can confer resilience to disturbances such as wildfire, drought, and insect outbreaks [@Stephens2008; @North2009; @Virah-Sawmy2009]. In the southwestern United States, many forests are experiencing "unhealthy" [*sensu* @Raffa2009] conditions which compromises their resilience and leaves them prone to catastrophic shifts in ecosystem type [@Millar2015]. Warmer temperatures coupled with recurrent drought (i.e., "hotter droughts") exacerbate water stress on trees [@ParkWilliams2012; @Millar2015] and a century of fire suppression policy has led to a drastic densification and homogenization of forest structure [@Stevens2017; @Safford2017]. Combined, these changes are liable to upset the feedbacks between forest structure and pattern-forming ecological disturbances that historically stabilized the system and made it resilient. For instance in the yellow pine/mixed-conifer forests of California's Sierra Nevada mountain range, wildfires kill much larger contiguous patches of trees than in the several centuries prior to Euroamerican settlement making natural forest regeneration after these megadisturbances uncertain [@Miller2007; @Stevens2017; @Safford2017; @Steel2018]. Forests are of high management priority given their essential ecological roles and valued ecosystem services [@Hansen2013; @Crowther2015; @Millar2015; @Trumbore2015], thus it is critical to understand the scope and scale of how spatial structural variability underlies forest resilience. 

Resilience of forest ecosystems is fundamentally challenging to quantify because forests comprise long-lived species, span large geographic extents, and are affected by disturbances at a broad range of spatial scales. The ease or difficulty with which a disturbance changes a system's state is termed resistance, and it is a key component of resilience [@Walker2004; though some treatments in forest ecology define "resistance" as a distinct process from "resilience" see @Millar2007]. A system state change can be distinguished by the loss of its characteristic native biota [@Keith2013], and thus wildfire disturbance alters a forest system state when it kills overstory trees. Using this framework, a forest system that is resistant to wildfire should generally experience less tree mortality when a fire inevitably occurs.

Wildfire severity describes the effect of a wildfire on an ecosystem-- often the proportion of vegetation mortality [@Sugihara2006]. Wildfire severity can be measured by comparing pre- and post-fire satellite imagery for a specific area, but this usually requires considerable manual effort for image collation and processing, followed by calibration with field data [@Miller2007; @Miller2009a; @DeSantis2010; @Cansler2012; @Veraverbeke2013; @Parks2014; @Prichard2014; @Edwards2018; @Fernandez2018]. Efforts to measure severity across broad spatial extents, such as the Monitoring Trends in Burn Severity project [@Eidenshink2007], are motivated by and fulfill management needs in response to individual fires but are unsuitably subjective for scientific analysis across wildfires [@Kolden2015]. Automated efforts to remotely assess wildfire have arisen, but they tend to focus on more aggregate measures of wildfire such as whether an area burned or the probability that it burned rather than the severity of the burn (@Bastarrika2011; @Goodwin2014; @Boschetti2015; @Hawbaker2017 but see @Reilly2017 and @Parks2018). Here, we present a method to automate the measurement of wildfire severity using minimal user inputs: a geometry of interest (a wildfire perimeter or a field plot location) and an alarm date (the date the fire was discovered). This information is readily available in many fire-prone areas (such as California, via the Fire and Resource Assessment Program; http://frap.fire.ca.gov/projects/fire_data/fire_perimeters_index) or could be derived using existing products (such as the Landsat Burned Area Essential Climate Variable product described in @Hawbaker2017). 

Vegetation characteristics such as canopy density [@Rouse1973; @Young2017], moisture content [@Asner2015], insect attack [@Nasi2015], and even functional diversity [@Asner2017] can be measured using remotely-sensed imagery. Texture analysis of imagery can quantify ecologically relevant local environmental heterogeneity across broad spatial extents [@Wood2012]. Developed for image classification and computer vision, texture analysis characterizes each pixel in an image by a summary statistic of its neighboring pixels [@Haralick1973; @Conners1984]. The value of each pixel represents a measure of local heterogenity within a predefined moving window, and the heterogeneity measurement itself varies across each pixel in the image. Ecologists have successfully used texture measurements to augment predictions of ecosystem properties such as species richness (@Huang2014; @Stein2014a; @Tuanmu2015 but see @Culbert2012).

### Creation and maintenance of forest spatial variability

Forest structure is defined by the size, species identity, and spatial distribution of trees on the landscape. Differences in tree crown heights characterize vertical structure, while differences in the rooting locations of trees characterize horizontal structure [@North2009]. Competition for light, water, and other resources can yield aggregations of trees within favorable microsites, as well as areas containing trees that are more widely spaced where resources are more limiting [@Clyatt2016]. Demographic processes of dispersal, recruitment, and mortality affect forest structure by adding or subtracting whole trees. Reciprocally, forest structure can also influence these pattern-forming processes. For example, vegetation overstory density alters microclimate and changes understory tree demographic rates [@Larson2012; @DeFrenne2013; @Ford2013]. The stabilizing effects of these reciprocal processes in forests are hallmarks of a resilient system [@Folke2004]. In low- to mid-elevation forests of the Sierra Nevada range of California, one of the strongest feedbacks between forest structure and pattern-generating ecological process is wildfire, which affects hundreds of thousands to millions of hectares of forested area per year [@Larson2012; @ParkWilliams2012; @Millar2015]. 

Wildfire interacts dynamically with forest structure [@Westerling2006; @ParkWilliams2012; @Larson2012]. Wildfire affects future forest structure by changing demographic rates of individual trees (e.g. increasing growth or germination via increasing light or nitrogen availability), but its most lasting impact to forest structure is in the pattern of killed trees left in its wake [@Larson2012]. Wildfire behavior is inherently complex and is influenced by local weather, topography, and heterogeneous fuel conditions created by departures from the average fire return interval at any particular place [@Sugihara2006; @Collins2010]. For instance, high tree density and presence of “ladder fuels” in the understory increase the probability of crown fire that kills a high proportion of trees [@Agee2005; @Stephens2008]. A heterogeneous forest can largely avoid overstory tree mortality because a reduced amount of accumulated ladder fuel decreases its ability to get into the crown (where mortality is more likely to result), because wide spacing between tree clumps interrupts high-severity fire spread across the landscape, and because small tree clumps with fewer trees don’t facilitate self-propagating fire behavior [@Graham2004; @Scholl2010]. In forests with relatively intact fire regimes and heterogeneous stand conditions such as in the Jeffrey pine/mixed-conifer forests of the Sierra San Pedro Mártir in Baja, California, there tends to be reduced vegetation mortality after wildfires compared to fire-suppressed forests [@Stephens2008]. Thus, forests with heterogeneous structure are predicted to persist due to their resistance to inevitable wildfire disturbance [@Graham2004; @Moritz2005; @Stephens2008]. However, it is unclear whether this is true at broad spatial extents, nor is it resolved at what scale variability in forest structure is meaningful for resilience [@Kotliar1990]. 

We use Landsat satellite data and a new image processing approach to calculate wildfire severity for all Sierra Nevada wildfires since 1984 that burned in yellow pine/mixed-conifer forest and covered more than 4 hectares. We calibrate 56 configurations of our algorithmic approach to ground-based wildfire severity measurements, and select the best performing severity metric to generate a comprehensive, system-wide severity dataset. We pair these data with image texture analysis to ask: (1) does spatial variability in forest structure increase the resilience of California yellow pine/mixed-conifer forests by reducing the severity of wildfires? (2) At what scale does any effect of spatial variability on wildfire severity have the most support? and (3) Does the influence of structural variability on fire severity depend on topographic, fire weather, or other fuel conditions?

# Methods

## Study system

```{r, results = "hide"}
fig_nums(name = "fig-study-geographic-setting")
```

![Geographic setting of the study. A) Location of yellow pine/mixed-conifer forests as designated by the Fire Return Interval Departure (FRID) product which, among other things, describes the potential vegetation in an area based on the pre-Euroamerican settlement fire regime. B) Locations of all fires covering greater than 4 hectares that burned in yellow pine/mixed-conifer forest between 1984 and 2017 in the Sierra Nevada mountain range of California according to the State of California Fire Resource and Assessment Program database, the most comprehensive database of fire perimeters of its kind. Colors indicate how many fire perimeters overlapped a given pixel within the study time period. C) (red) Locations of composite burn index (CBI) ground plots used to calibrate the remotely sensed measures of severity. (black) Locations of random samples drawn from 972 unique fires depicted in panel B that were in yellow pine/mixed-conifer forest as depicted in panel A, and which were designated as "burned" by exceeding a threshold relative burn ratio (RBR) determined by calibrating the algorithm presented in this study with ground-based CBI measurements.](../figures/study-geographic-setting.pdf)

Our study assesses the effect of vegetation structure on wildfire severity in the Sierra Nevada mountain range of California in yellow pine/mixed-conifer forests (`r fig_nums(name = "fig-study-geographic-setting", display = "cite")`). This system is dominated by a mixture of conifer species including ponderosa pine (*Pinus ponderosa*), sugar pine (*Pinus lambertiana*), incense-cedar (*Calocedrus decurrens*), Douglas-fir (*Pseudotsuga menziesii*), white fir (*Abies concolor*), and red fir (*Abies magnifica*), angiosperm trees primarily including black oak (*Quercus kelloggii*), as well as shrubs [@Stephens2004; @Collins2015; @Safford2017]. We considered "yellow pine/mixed-conifer forest" to be all area designated as a yellow pine, dry mixed-conifer, or moist mixed-conifer pre-settlement fire regime (PFR) in the USFS Fire Return Interval Departure database (https://www.fs.usda.gov/detail/r5/landmanagement/gis/?cid=STELPRDB5327836), which reflects potential vegetation and is less sensitive to recent land cover change [@Steel2018]. We considered the Sierra Nevada region to be the area within the Sierra Nevada Foothills, the High Sierra Nevada, and the Tehachapi Mountain Area Jepson ecoregions [@Jepson2016]. 

## A new approach to remotely sensing wildfire severity

We measured forest vegetation characteristics and wildfire severity using imagery from the Landsat series of satellites [@Eidenshink2007; @Miller2007] with radiometric correction post-processing [@Masek2006; @Vermote2016; @USGSledaps2017; @USGSlasrc2017]. Landsat satellites image the entire Earth approximately every 16 days with a 30m pixel resolution, and repeat images of the same area are geometrically coregistered such that overlapping pixels correspond to the same area on the ground. We used Google Earth Engine, a massively parallel cloud-based geographic information system and image hosting platform, for all image collation and processing [@Gorelick2017].

We calculated wildfire severity for the most comprehensive digital record of fire perimeters in California: The California Department of Forestry and Fire Protection, Fire and Resource Assessment Program (FRAP) fire perimeter database (http://frap.fire.ca.gov/projects/fire_data/fire_perimeters_index). The FRAP database includes all known fires that covered more than 4 hectares, compared to the current standard severity database in this region which only includes fires covering greater than 80 hectares [@Miller2007; @Miller2012; @Miller2012a; @Steel2018]. By measuring severity on smaller fires, we are able to better investigate general features of wildfire behavior in this system because large fires often are able to grow large only after escaping initial suppression efforts. Only 2% of fires escape initial containment efforts and grow to >120 hectares in size, but these larger fires constitute 97.5% of total burned area often burn under extreme fuel and weather conditions [@Calkin2005]. Thus, suppression activity exerts a strong influence on wildfire behavior, whereby the larger fires measured in most severity databases may not be representative of typical fire behavior [@Safford2017]. Using the FRAP database of fire perimeters, we quantified fire severity within each perimeter of `r frap_fire_count_ypmc` wildfires in the Sierra Nevada yellow pine/mixed-conifer forest that burned between 1984 and 2017. Our approach increases the total burned area with severity measurments in this system from `r as.character(round(r5_area_ypmc_burned))` to `r as.character(round(frap_area_ypmc_burned))` hectares (a difference of only `r as.character(round((frap_area_ypmc_burned - r5_area_ypmc_burned)))` hectares), but more than doubles the number of fire events represented (from `r r5_fire_count_ypmc` to `r frap_fire_count_ypmc` fires).

### Fetching and processing pre- and postfire imagery

```{r, results = "hide"}
fig_nums(name = "fig-image-acquisition-algorithm")
```

We leveraged the cloud-based data catalog, the large parallel processing system, and the distribution of computation tasks in Google Earth Engine to enable rapid high-throughput analyses using millions of gigabytes of earth observation data [@Gorelick2017]. Our programmatic assessment of wildfire severity across the `r frap_fire_count_ypmc` Sierra Nevada yellow pine/mixed-conifer fires in the FRAP perimeter database, which required fetching thousands of Landsat images and performing dozens of calculations across them, was automated and took less than an hour to complete.

For each fire perimeter, we fetched a time series of prefire Landsat images starting the day before the fire alarm date and extending backward in time by a user-defined time window. An analogous postfire time series of Landsat imagery was fetched exactly one year after the date range used to filter the prefire collection. We tested 4 time windows: 16, 32, 48, or 64 days which were chosen to ensure that at least 1, 2, 3, or 4 Landsat images were captured by the date ranges (`r fig_nums(name = "fig-image-acquisition-algorithm", display = "cite")`). The Landsat archive we filtered included imagery from Landsat 4, 5, 7, and 8, so each pre- and postfire image collection may contain a mix of scenes from different satellite sources to enhance coverage. For each image in the pre- and postfire image collections, we masked pixels that were not clear (i.e., clouds, cloud shadows, snow, and water).

![Schematic for how Landsat imagery was assembled in order to make comparisons between pre- and post-fire conditions. This schematic depicts a 64-day window of image collation prior to the fire which comprise the pre-fire image collection. A similar, 64-day window collection of imagery is assembled one year after the pre-fire image collection.](../figures/image-acquisition-algorithm.pdf)

For each Landsat image in the prefire and postfire collections, we calculated standard indices that capture vegetation cover and fire effects such as charring. Normalized difference vegetation index (NDVI) correlates with vegetation density, canopy cover, and leaf area index [@Rouse1973]. Normalized burn ratio (NBR) and normalized burn ratio version 2 (NBR2) respond strongly to fire effects on vegetation [@Lopez1991; @Key2006; @USGSlasrc2017; @USGSledaps2017; @Hawbaker2017] (Equations in Supplmental Methods).

We composited each pre- and postfire image collection (including the pixel values representing NDVI, NBR, and NBR2) into a single pre- and postfire image using a median reducer, which calculated the median of the unmasked values on a per-pixel basis across the stack of images in each collection. Composite pre- and postfire images can be successfully used to measure wildfire severity instead of using raw, individual images [@Parks2018].

### Calculating wildfire severity

Using the compositing approach, we calculated the most commonly used metrics of remotely-sensed wildfire severity to validate against ground-based data: the relative burn ratio (RBR) [@Parks2014], the delta normalized burn ratio (dNBR) [@Eidenshink2007; @Miller2007], the relative delta normalized burn ratio (RdNBR) [@Miller2007; @Miller2012a], the delta normalized burn ratio 2 (dNBR2) [@Hawbaker2017], the relative delta normalized burn ratio 2 (RdNBR2), and the delta normalized difference vegetation index (dNDVI) [@Eidenshink2007]. We also calculate a new, analogous metric to the RdNBR using NDVI-- the relative delta normalized difference vegetation index (RdNDVI). We calculated the delta severity indices (dNBR, dNBR2, dNDVI) without multiplying by a rescaling constant (e.g., we did not multiply the result by 1000 as in @Miller2007). Following @Reilly2017, we did not correct the delta indices using a phenological offset value, as our approach implicitly accounts for phenology by incorporating multiple cloud-free images across the same time window both before the fire and one year later. (Full equations can be found in the Supplemental Methods)

Example algorithm outputs are shown in `r fig_nums(name = "fig-pre-post-rbr", display = "cite")`.

![Example algorithm outputs for the Hamm Fire of 1987 (top half) and the American Fire of 2013 (bottom half) showing: prefire true color image (left third), postfire true color image (center third), relative burn ratio (RBR) calculation using a 48-day image collation window before the fire and one year later (right third). For visualization purposes, these algorithm outputs have been resampled to a resolution of 100m x 100m from their original resolution of 30m x 30m. Data used for analyses were sampled from the outputs at the original resolution.](../figures/pre-post-rbr.pdf)

### Calibrating remotely-sensed wildfire severity with field-measured wildfire severity

We calibrated our remotely-sensed measure of wildfire severity with `r total_conifer_cbi_plots` field measures of overstory tree mortality from two previously published studies [@Zhu2006; @Sikkink2013] (`r fig_nums(name = "fig-study-geographic-setting", display = "cite")`). The Composite Burn Index (CBI) is a metric of vegetation mortality across several vertical vegetation strata within a 30m diameter field plot [@Key2006]. The CBI ranges from 0 (no fire impacts) to 3 (very high fire impacts), and has a long history of use as a standard for calibrating remotely-sensed severity data [@Key2006; @Miller2007; @Miller2009a; @Cansler2012; @Parks2014; @Prichard2014; @Parks2018].  Following @Miller2007, @Miller2009a, @Parks2014, and @Parks2018, we fit a non-linear model to each remotely-sensed severity metric of the following form:

```{r eq-cbi-calibration, results = "hide"}
eq_nums(name = "eq-cbi-calibration")
```

(@eq-cbi-calibration) $\label{eq-cbi-calibration}
\text{remote\_severity} = \beta_0 + \beta_1 e^{\beta_2 \text{cbi\_overstory}}$

We fit the model in `r eq_nums(name = "eq-cbi-calibration", display = "cite")` for all 7 of our remotely-sensed severity metrics (RBR, dNBR, RdNBR, dNBR2, RdNBR2, dNDVI, RdNDVI) using 4 different time windows from which to collate satellite imagery (16, 32, 48, and 64 days). Following @Cansler2012, @Parks2014, and @Parks2018, we used bilinear interpolation to extract remotely-sensed severity at the locations of the CBI field plots to better align remote and field measurements. We also extracted remotely-sensed severity values using bicubic interpolation. In total, we fit 56 models (7 severity measures, 4 time windows, 2 interpolation methods) and performed five-fold cross validation using the `modelr` and `purrr` packages in R [@Wickham2017; @Henry2018; @RCoreTeam2018]. To compare goodness of model fits with @Miller2007, @Miller2009a, and @Parks2014, we report the average R^2^ value from the five folds for each of the 56 models. 

## Remote sensing other conditions

### Variability of vegetation

```{r, results = "hide"}
fig_nums(name = "fig-heterogeneity-raster")
```

We used texture analysis to calculate a remotely-sensed measure of local forest variability [@Haralick1973; @Tuanmu2015]. Within a moving square neighborhood window with sides of 90m, 150m, 210m, and 270m, we calculated forest variability for each pixel as the standard deviation of the NDVI values of its neighbors (not including itself). NDVI correlates well with foliar biomass, leaf area index, and vegetation cover [@Rouse1973], so a higher standard deviation of NDVI within a given local neighborhood corresponds to discontinuous canopy cover and abrupt vegetation edges (see `r fig_nums(name = "fig-heterogeneity-raster", display = "cite")`) [@Franklin1986]. Canopy cover is positively correlated with surface fuel loads including dead and down wood, grasses, and short shrubs [@Lydersen2015; @Collins2016], which are primarily responsible for initiation and spread of "crowning" fire behavior which kills overstory trees [@Stephens2012a].

![Example of homogenous forest (top row) and heterogenous forest (bottom row) with the same mean NDVI values (~0.6). Each column represents forest structural variability measured using a different neighborhood size. \label{fig-heterogeneity-raster}](../figures/heterogeneity-demo-raster.pdf)

### Topographic conditions

Elevation data were sourced from the Shuttle Radar Topography Mission [@Farr2007], a 1-arc second digital elevation model. Slope and aspect were extracted from the digital elevation model. Per-pixel topographic roughness was calculated as the standard deviation of elevation values within a the same kernel sizes as those used for variability in forest structure  (90m, 150m, 210m, and 270m on a side and not including the central pixel).

We used the digital elevation model to calculate the potential annual heat load at each pixel, which is an integrated measure of latitude, slope, and a folding transformation of aspect about the northeast-southwest line (@McCune2002 with correction in @McCune2007; See Supplemental Methods for equations)

### Moisture conditions

The modeled 100-hour fuel moisture data were sourced from the gridMET product, a gridded meteorological product with a daily temporal resolution and a 4km x 4km spatial resolution [@Abatzoglou2013a]. We calculated 100-hour fuel moisture as the median 100-hour fuel moisture for the 3 days prior to the fire. The 100-hour fuel moisture is a correlate of the regional temperature and moisture which integrates the relative humidity, the length of day, and the amount of precipitation in the previous 24 hours. Thus, this measure is sensitive to multiple hot dry days across the 4km x 4km spatial extent of each grid cell, but not to diurnal variation in relative humidity.  

### Remote samples

Approximately 100 random points were selected within each FRAP fire perimeter in areas designated as yellow pine/mixed-conifer forest and the values of wildfire severity as well as the values of each covariate were extracted at those points using nearest neighbor interpolation. Using the calibration equation described in `r eq_nums(name = "eq-cbi-calibration", display = "cite")` for the best configuration of the remote severity metric, we removed sampled points corresponding to "unburned" area prior to analysis (i.e., below an RBR threshold of `r print_cbi_models[1, "low_sev"] %>% pull()`. The random sampling amounted to `r total_conifer_samps` total samples across `r frap_fire_count_ypmc` fires.

## Modeling the effect of forest variability on severity

We used the Relative Burn Ratio (RBR) calculated using bicubic interpolation within a 48-day window to derive our response variable for analyses of forest structural variability, as it showed the best correspondence to field severity data measured as average R^2^ in the 5-fold cross validation. Using the non-linear relationship between RBR and CBI from the best performing calibration model, we calculated the threshold RBR that corresponds to "high-severity" signifying complete or near-complete overstory mortality (RBR value of `r print_cbi_models[1, "hi_sev"] %>% pull()` corresponding to a CBI value of 2.25). If the severity at a remote sample point was greater than this threshold, the point was scored as a 1. We used the mixed effects logistic regression model described in `r eq_nums(name = "eq-severity-model", display = "cite")` to assess the effect of covariates on the probability of high-severity wildfire. We scaled all continuous predictor variables, and treated each individual fire as having a random intercept effect.

(@eq-severity-model)
$\begin{aligned}
\label{eq-severity-model}
severity_{i, j} &\sim Bern(\phi_{i,j}) \\
logit(\phi_{i,j}) &= 
\begin{aligned}
& \beta_0 + \\
& \beta_{\text{nbhd\_stdev\_NDVI}} * \text{nbhd\_stdev\_NDVI}_i + \\
& \beta_{\text{prefire\_NDVI}} * \text{prefire\_NDVI}_i + \\
& \beta_{\text{nbhd\_mean\_NDVI}} * \text{nbhd\_mean\_NDVI}_i + \\
& \beta_{\text{fm100}} * \text{fm100}_i + \\
& \beta_{\text{pahl}} * \text{pahl}_i + \\
& \beta_{\text{topographic\_roughness}} * \text{topographic\_roughness}_i + \\
& \beta_{\text{nbhd\_stdev\_NDVI*fm100}} * \text{nbhd\_stdev\_NDVI}_i * \text{fm100}_i + \\
& \beta_{\text{nbhd\_stdev\_NDVI*prefire\_NDVI}} * \text{nbhd\_stdev\_NDVI}_i * \text{prefire\_NDVI}_i + \\
& \beta_{\text{nbhd\_stdev\_NDVI*nbhd\_mean\_NDVI}} * \text{nbhd\_stdev\_NDVI}_i * \text{nbhd\_mean\_NDVI}_i + \\
& \beta_{\text{nbhd\_mean\_NDVI*prefire\_NDVI}} * \text{nbhd\_mean\_NDVI}_i * \text{prefire\_NDVI}_i + \\
& \gamma_j
\end{aligned}
\\
\gamma_j &\sim \mathcal{N}(0, \sigma_{\text{fire}})
\end{aligned}$

## Assessing the relevant scale of forest variability

Each neighborhood size (90m, 150m, 210m, 270m on a side) was substituted in turn for the neighborhood standard deviation of NDVI, neighborhood mean NDVI, and terrain ruggedness covariates to generate a candidate set of 4 models. To assess the scale at which the forest structure variability effect manifests, we compared the 4 candidate models based on different neighborhood sizes using leave-one-out cross validation (LOO cross validation) [@Vehtari2016].  We inferred that the neighborhood size window used in the best-performing model reflected the scale at which the forest structure variability effect had the most support. 

## Statistical software and data availability

We used `R` for all statistical analyses [@RCoreTeam2018]. We used the `brms` package to fit mixed effects models in a Bayesian framework which implements the No U-Turn Sampler (NUTS) extension to the Hamiltonian Monte Carlo algorithm [@Hoffman2014; @Burkner2017]. We used 4 chains with 3000 samples per chain (1500 warmup samples and 1500 posterior samples) and chain convergence was assessed for each estimated parameter by ensuring Rhat values were less than or equal to 1.01 [@Burkner2017].

# Results

We found that the remotely sensed relative burn ratio (RBR) metric of wildfire severity measured across a 48-day interval prior to the wildfire discovery date correlated best with ground-based composite burn index (CBI) measurements of severity (5-fold cross validation $R^2 =$ `r print_cbi_models$r2_kfold[1]`; `r fig_nums(name = "fig-cbi-calibration", display = "cite")`; Supp. Table 1). Our method to calculate remotely sensed severity using automated Landsat image fetching performs as well or better than most other reported methods that use hand-curation of Landsat imagery (see review in @Edwards2018). Further, several combinations of remotely sensed severity metrics, time windows, and interpolation methods validate well with the ground based severity metrics, including those based on NDVI which is calculated using reflectance in shorter wavelengths than those typically used for measuring severity (`r fig_nums(name = "fig-cbi-calibration", display = "cite")`). The top three configurations of our remotely sensed severity metric are depicted in `r fig_nums(name = "fig-cbi-calibration", display = "cite")`.

```{r, results = "hide"}
fig_nums(name = "fig-cbi-calibration")
```

![Three top performing remotely-sensed severity metrics based on 5-fold cross validation (relative burn ratio, 48-day window, bicubic interpolation; relative delta normalized burn ratio, 32-day window, bilinear interpolation; and relative delta normalized difference vegetation index, 48-day window, bilinear interpolation) calculated using new automated image collation algorithms, calibrated to `r total_conifer_cbi_plots` field measures of fire severity (composite burn index). See Supplemental Table 1 for performance of all tested models.](../figures/remote-sensed-severity-calibration.pdf)

```{r, results = "hide", eval = FALSE}
table_nums(name = "table-cbi-models")
```

```{r cbi_models_table, results = "hide", eval = FALSE}
knitr::kable(print_cbi_models,
             # format = "latex",
             longtable = TRUE,
             booktabs = TRUE,
             caption = "Comparison of models used to validate and calibrate remotely sensed wildfire severity with ground based composite burn index (CBI) severity sorted in descending order by the $R^2$ value from a 5-fold cross validation. A total of 56 models were tested representing all possible combinations of 7 different measures of wildfire severity (RBR, dNBR, dNBR2, RdNBR, RdNBR2, dNDVI, and RdNDVI), 4 different time windows in which Landsat imagery was acquired and summarized with a median reducer on a pixel-by-pixel basis (16 days, 32 days, 48 days, and 64 days), and two different interpolation methods (bilinear and bicubic). The three parameters (\\textbeta\\textsubscript{0}, \\textbeta\\textsubscript{1}, and \\textbeta\\textsubscript{2}) from the nonlinear model fit described in Eq. \\ref{eq-cbi-calibration} are reported. For each model, the value of the remotely sensed wildfire severity measurement corresponding to the lower bounds of 3 commonly used categories of severity are reported ('low' corresponds to a CBI value of 0.1, 'mod' corresponds to a CBI value of 1.25, and 'high' corresponds to a CBI value of 2.25)",
             caption.short = "Comparison of models used to validate and calibrate remotely sensed wildfire severity with CBI severity",
             escape = FALSE,
             col.names = c("Rank", "\\makecell[c]{Severity\\\\measure}", "\\makecell[c]{Time\\\\window}", "Interpolation", "\\makecell[c]{k-fold\\\\$R^2$}", "\\makecell[c]{\\textbeta\\textsubscript{0}}", "\\makecell[c]{\\textbeta\\textsubscript{1}}", "\\makecell[c]{\\textbeta\\textsubscript{2}}", "low", "mod", "high")) %>%
  kable_styling(latex_options = c("repeat_header"))
```

```{r param_estimates_latex, eval = FALSE}
knitr::kable(ci_betas_print_table,
             # format = "latex",
             caption = "Model parameter estimates for different neighborhood sizes.",
             caption.short = "Model parameter estimates",
             escape = FALSE,
             col.names = c("Coefficient", "\\makecell[c]{90m x 90m\\\\neighborhood}", "\\makecell[c]{150m x 150m\\\\neighborhood}", "\\makecell[c]{210m x 210m\\\\neighborhood}", "\\makecell[c]{270m x 270m\\\\neighborhood}"))
```

```{r param_estimates_word, eval = FALSE}
knitr::kable(ci_betas_print_table_simple,
             # format = "latex",
             caption = "Model parameter estimates for different neighborhood sizes.",
             caption.short = "Model parameter estimates",
             escape = FALSE,
             col.names = c("Coefficient", "90m x 90m neighborhood", "150m x 150m neighborhood}", "210m x 210m neighborhood", "270m x 270m neighborhood"))
```

Based on these model comparisons, we used the relative burn ratio (RBR) calculated using a 48-day time window before the fire and bicubic interpolation as our metric of severity. We created the boolean response variable representing whether the sampled point burned at high-severity or not by determining whether the RBR exceeded `r print_cbi_models$hi_sev[1]`, the threshold for high-severity derived using the non-linear relationship in `r eq_nums(name = "eq-cbi-calibration", display = "cite")` (`r fig_nums(name = "fig-cbi-calibration", display = "cite")`). 

## Neighborhood size effect

```{r, results = "hide"}
table_nums(name = "table-ic-table")
```

```{r ic_print_table}
knitr::kable(ic_print_table,
             # format = "latex",
             caption = "Comparison of four models described in Eq. \\ref{eq-severity-model} using different neighborhood sizes for calculating forest structural variability (standard deviation of NDVI within the neighborhood), neighborhood mean NDVI, and topographic roughness. LOO is calculated as -2 times the expected log pointwise predictive density (elpd) for a new dataset [@Vehtari2016]. The Bayesian R^2^ is a \"data-based estimate of the proportion of variance explained for new data\" [@Gelman2018]. Note that Bayesian R^2^ values are conditional on the model so shouldn't be compared across models, though they can be informative about a single model at a time.",
             caption.short = "Comparison of models using different neighborhood size windows to assess scale at which heterogeneity effect manifests",
             escape = FALSE,
             col.names = c("\\makecell[c]{Model}", "\\makecell[c]{Neighborhood size for\\\\variability measure}", "\\makecell[c]{LOO\\\\(-2*elpd)}", "\\makecell[c]{\\textDelta LOO\\\\to best model}", "\\makecell[c]{SE of\\\\\\textDelta LOO}", "\\makecell[c]{LOO\\\\model weight (\\%)}", "\\makecell[c]{Bayesian\\\\$R^2$}"),
             align = rep("c", times = 5))
```

The model with the best out-of-sample prediction accuracy assessed by leave-one-out cross validation was the model fit using the smallest neighborhood size for the variability of forest structure (standard deviation of neighborhood NDVI), the mean of neighborhood NDVI, and the terrain roughness (standard deviation of elevation) `r table_nums(name = "table-ic-table", display = "cite")`. Model weighting based on the LOO score suggests 100% of the model weight belongs to the model using the smallest neighborhood size window.

## Effects of prefire vegetation density, 100-hour fuel moisture, potential annual heat load, and topographic roughness on wildfire severity

```{r, results = "hide"}
fig_nums(name = "fig-main-effects")
```

![The main effects of the covariates having the strongest relationships with the probability of high-severity fire. All depicted relationships derive from the model using the 90m x 90m neighborhood size window for neighborhood standard deviation of NDVI, neighborhood mean of NDVI, and topographic roughness, as this was the best performing model of the four neighborhood sizes tested. The effect sizes of these covariates were similar for each neighborhood size tested.](../figures/prob-hi-sev-main-effects-credible-intervals.pdf)

We report the results from fitting the model described in `r eq_nums(name = "eq-severity-model", display = "cite")` using the smallest neighborhood size (90m x 90m) because this was the best performing model (see above) and because the size and magnitude of estimated coefficients were similar across neighborhood sizes (Supp. Table 2).

We found that the strongest influence on the probability of a forested area burning at high-severity was the density of the vegetation, as measured by the prefire NDVI at that central pixel. A greater prefire NDVI led to a greater probability of high-severity fire ($\beta_{\text{prefire\_ndvi}}=$ `r round(ci_betas %>% filter(param == "b_preFire_ndvi" & radius == 1) %>% select(mean) %>% pull(), 3)`; 95% CI: [`r paste(as.character(round(ci_betas %>% filter(param == "b_preFire_ndvi" & radius == 1) %>% select(lwr, upr), 3)), collapse = ", ")`]); `r fig_nums(name = "fig-main-effects", display = "cite")`). There was a strong negative relationship between 100-hour fuel moisture and wildfire severity such that increasing 100-hour fuel moisture was associated with a reduction in the probability of a high-severity wildfire ($\beta_{\text{fm100}}=$ `r round(ci_betas %>% filter(param == "b_fm100" & radius == 1) %>% select(mean) %>% pull(), 3)`; 95% CI: [`r paste(as.character(round(ci_betas %>% filter(param == "b_fm100" & radius == 1) %>% select(lwr, upr), 3)), collapse = ", ")`]) (`r fig_nums(name = "fig-main-effects", display = "cite")`). Potential annual heat load, which integrates aspect, slope, and latitude, also had a strong positive relationship with the probability of a high-severity fire. Areas that were located on southwest facing sloped terrain at lower latitudes had the highest potential annual heat load, and they were more likely to burn at high-severity ($\beta_{\text{pahl}}=$ `r round(ci_betas %>% filter(param == "b_pahl" & radius == 1) %>% select(mean) %>% pull(), 3)`; 95% CI: [`r paste(as.character(round(ci_betas %>% filter(param == "b_pahl" & radius == 1) %>% select(lwr, upr), 3)), collapse = ", ")`]) `r fig_nums(name = "fig-main-effects", display = "cite")`). We found no effect of local topographic roughness on wildfire severity ($\beta_{\text{topographic\_roughness}}=$ `r round(ci_betas %>% filter(param == "b_topo_roughness" & radius == 1) %>% select(mean) %>% pull(), 3)`; 95% CI: [`r paste(as.character(round(ci_betas %>% filter(param == "b_topo_roughness" & radius == 1) %>% select(lwr, upr), 3)), collapse = ", ")`]). We found a negative effect of the prefire neighborhood mean NDVI on the probability of a pixel burning at high-severity ($\beta_{\text{nbhd\_mean\_NDVI}}=$ `r round(ci_betas %>% filter(param == "b_neighborhood_mean" & radius == 1) %>% select(mean) %>% pull(), 3)`; 95% CI: [`r paste(as.character(round(ci_betas %>% filter(param == "b_neighborhood_mean" & radius == 1) %>% select(lwr, upr), 3)), collapse = ", ")`]). This is in contrast to the positive effect of the prefire NDVI of the pixel itself. 

There was also a strong negative interaction between the neighborhood mean NDVI and the prefire NDVI of the central pixel ($\beta_{\text{nbhd\_mean\_NDVI*prefire\_NDVI}}$ `r round(ci_betas %>% filter(param == "b_neighborhood_mean_ndvi.preFire_ndvi" & radius == 1) %>% select(mean) %>% pull(), 3)`; 95% CI: [`r paste(as.character(round(ci_betas %>% filter(param == "b_neighborhood_mean_ndvi.preFire_ndvi" & radius == 1) %>% select(lwr, upr), 3)), collapse = ", ")`]). 

### Effect of variability of vegetation structure on wildfire severity

We found strong evidence for a negative effect of variability of vegetation structure on the probability of a high-severity wildfire ($\beta_{\text{nbhd\_stdev\_NDVI}}=$ `r round(ci_betas %>% filter(param == "b_het" & radius == 1) %>% dplyr::select(mean) %>% pull(), 3)`; 95% CI: [`r paste(as.character(round(ci_betas %>% filter(param == "b_het" & radius == 1) %>% dplyr::select(lwr, upr), 3)), collapse = ", ")`]); `r fig_nums(name = "fig-main-effects", display = "cite")`). We also found significant interactions between variability of vegetation structure and prefire NDVI $\beta_{\text{nbhd\_stdev\_NDVI*prefire\_NDVI}}=$ `r round(ci_betas %>% filter(param == "b_het_ndvi.preFire_ndvi" & radius == 1) %>% dplyr::select(mean) %>% pull(), 3)`; 95% CI: [`r paste(as.character(round(ci_betas %>% filter(param == "b_het_ndvi.preFire_ndvi" & radius == 1) %>% dplyr::select(lwr, upr), 3)), collapse = ", ")`]); `r fig_nums(name = "fig-main-effects", display = "cite")`) as well as between variability of vegetation structure and neighborhood mean NDVI ($\beta_{\text{nbhd\_stdev\_NDVI*nbhd\_mean\_NDVI}}=$ `r round(ci_betas %>% filter(param == "b_het_ndvi.neighborhood_mean_ndvi" & radius == 1) %>% dplyr::select(mean) %>% pull(), 3)`; 95% CI: [`r paste(as.character(round(ci_betas %>% filter(param == "b_het_ndvi.neighborhood_mean_ndvi" & radius == 1) %>% dplyr::select(lwr, upr), 3)), collapse = ", ")`]); `r fig_nums(name = "fig-main-effects", display = "cite")`).

# Discussion

## A new approach to remotely sensing wildfire severity

Broad-extent, fine-grain, spatially-explicit analyses of whole ecosystems are key to illuminating macroecological phenomena  [@Heffernan2014]. We used a powerful, cloud-based geographic information system and data repository, Google Earth Engine, as a 'macroscope' [@Beck2012] to study feedbacks between vegetation structure and wildfire disturbance in yellow pine/mixed-conifer forests of California's Sierra Nevada mountain range. With this approach, we reveal and quantify general features of this forest system, and gain deeper insights into the mechanisms underlying its function.

We developed a new approach to calculating wildfire severity using remotely sensed images from the Landsat series of satellites using a minimal amount of user input-- a geometry (e.g., a point location of a field plot or a fire perimeter polygon) and a fire discovery date. We found that the relative burn ratio (RBR) calculated using prefire Landsat images collected over a 48-day period prior to the fire and postfire Landsat images collected over a 48-day period one year after the prefire images validated the best with ground based severity measurements (composite burn index; CBI). 

Interpolation is a well-recognized technique to improve the comparability of remotely-sensed imagery to ground-based, fine-scale measurements. It is unlikely that a ground measurement occurs exactly at the center of a pixel, so borrowing information from neighboring pixels improves the representativeness of remotely sensed data to ground data [@Cansler2012]. Bilinear interpolation, which averages the 4 nearest pixels, is often used but we found that bicubic interpolation, which averages the nearest 16 pixels, performs slightly better. Bicubic interpolation is more computationally intensive, but may be preferable when computational power isn't limiting.

Most efforts to calculate severity from satellite data rely on hand curation of a single prefire and a single postfire image [@Miller2007; @Miller2009a; @DeSantis2010; @Cansler2012; @Veraverbeke2013; @Parks2014; @Prichard2014; @Edwards2018; @Fernandez2018]. Recently, @Parks2018 found that using a composite of several prefire images and several postfire images to detect fire impacts performed at least as well as using a single pre- and post-fire image, which also facilitated automated image fetching. @Parks2018 used 3- to 4-month windows during pre-specified times of the year (depending on the fire's region) to collate pre- and postfire imagery one year before the fire and one year after. In contrast, we tested multiple time window lengths based on the fire start date regardless of when it burned during the year. Basing our pre- and postfire image fetching on fixed lengths of time since the fire start date standardized the amount of time elapsed in each severity assessment. Our best remotely sensed severity configuration used a much shorter time window compared to @Parks2018 (48 days versus 3 to 4 months), which likely balanced an incorporation of enough imagery to be representative of the pre- and post-fire vegetation conditions but not so many images that different phenological conditions across the time window added noise to each composite. 

Many algorithms have been developed to measure fire effects on vegetation in an attempt to better correspond to field data [@Key2006; @Miller2007; @Parks2014]. We found that several other remotely sensed measures of severity, including one based on NDVI that is rarely deployed, validated nearly as well with ground-based data as the best configuration (the Relative Burn Ratio). We echo the conclusion of @Zhu2006 that the validation of differences between pre- and postfire NDVI to field measured severity data, which uses near infrared reflectance, is comparable to validation using more commonly used severity metrics (e.g., RdNBR and RBR) that rely on short wave infrared reflectance. One immediately operational implication of this is that the increasing availability of low-cost small unhumanned aerial systems (sUAS a.k.a. drones) and near infrared detecting imagers (e.g., those used for agriculture monitoring) may be used to reliably measure wildfire severity at very high spatial resolutions.

## Factors influencing the probability of high-severity wildfire

We found that the strongest influence on the probability of high-severity wildfire within any pixel was the prefire NDVI of that pixel. NDVI correlates with vegetation density and greater amounts of vegetation may translate directly to greater live fuel loads as suggested by @Parks2018, who found a similar relationship. However in yellow pine/mixed-conifer forest, live crown biomass plays a much smaller role in driving high severity fire compared to surface fuel loads [@Stephens2012a]. Surface fuel load positively correlates with overstory canopy cover [@Lydersen2015; @Collins2016], which correlates with NDVI [@Rouse1973] and thus the increasing probability of high severity fire with greater NDVI is likely to be driven by greater surface fuel loads.

We found a strong positive effect of potential annual heat load as well as a strong negative effect of 100-hour fuel moisture, which corroborates similar studies [@Parks2018b]. Some work has shown that terrain ruggedness [@Holden2009], and particularly coarser-scale terrain ruggedness [@Dillon2011], is an important predictor of wildfire severity, but we found no effect using our measure of terrain ruggedness.

## Feedback between forest structural variability and wildfire severity

Critically, we found a strong negative effect of variability of vegetation structure on wildfire severity, approximately equal to the magnitude of the effect of the potential annual heat load. Just as the effect of NDVI is likely driven by surface fuel loads, the effect of variability in NDVI (our measure of structural varaibility), is likely driven by a lack of continuity in surface fuel loads, which can reduce the probability of initiation and spread of tree-killing crown fires [@VanWagner1977; @Agee1996; @Scott2001; @Graham2004; @Agee2005].

The system-wide negative relationship between forest structural variability and wildfire severity that we present closes a feedback loop that makes Sierra Nevada yellow pine/mixed-conifer forests resilient to wildfire. Wildfires that burn with a mixture of low, moderate, and high-severity generate variable forest structure [@Malone2018; @Collins2018]. High proportions of high-severity wildfire, especially when high-severity fire occurs in large, contiguous patches that are uncharacteristic of the system's natural range of variation, are at a higher risk for type conversion to non-forest. [@VanWagtendonk2006; @Coppoletta2016; @Stephens2013; @Millar2015; @Safford2017]. In contrast, forests with fire regimes more similar to their natural range of variation are less likely to experience type conversion [@Walker2018]. Thus, the relative proportion and patch configuration of high-severity fire compared to lower severity fire in the yellow pine/mixed-conifer system is a key determinant of their long term persistence [@Stevens2017; @Steel2018]. For instance, @Miller2017 found that half of the yellow pine/mixed-conifer system would reach an old-growth condition under pre-suppression levels of high-severity fire, but that only 13% of the forest would reach old-growth condition under modern, elevated probabilities of high-severity fire. 

Texture analysis has been used to measure habitat heterogeneity in ecology, but has only recently gained recognition for its potential to quantify system resilience in cases where texture measurements reflect the spatial process by which a system stabilizes [@Kefi2014]. In our case, we measure variability in vegetation structure as a spatial feature that is part of the feedback loop between wildfire disturbance and forest spatial structure. We gain insight into longer-term system dynamics by measuring a signature of the pattern forming process itself-- the negative relationship between structural variability and wildfire severity. More work is needed to assess the degree to which *changing* spatial features of yellow pine/mixed-conifer forests-- or the spatial features of the wildfire disturbance that affect them-- may capture the precariousness of a system to a state change (e.g., to a non-forested system) or an erosion of the underlying feedbacks that make a system resilient.

## Neighborhood size

We found that the effect of a forest patch's neighborhood characteristics on the probability of high-severity fire materialized at the smallest neighborhood size that we tested, 90m x 90m. This suggests that the moderating effect of variability in vegetation structure on fire severity is a very local phenomenon. This corroborates work by @Safford2012, who found that crown fires (with high tree killing potential) were almost always reduced to surface fires (with low tree killing potential) within 70m of entering an fuel reduction treatment area.

At a landscape level, forest treatments that reduce fuel loads and increase structural variability can be effective at reducing fire severity across broader spatial scales [@Schmidt2008; @Stephens2013a], which may reflect that severity patterns at broad scales are emergent properties of very local interactions between forest structure and fire behavior. The notion of emergent patterns of severity arising from local effects of vegetation structure is supported by work on fuel reduction treatments, which suggests that fire behavior can be readily modified with forest structural changes to only 20 (when strategically located) to 60% (when randomly located) of the landscape [@Graham2004].

Here, we investigated the effect of different scales of variability in forest structure separately to assess which scale, on average, was most relevant as a driver of wildfire severity. It is possible that the relevant scale of structural variability itself varies across the system. For instance, some work has demonstrated that the scale of the forest variability effect can depend on fire weather, with small-scale structural variability failing to influence fire behavior under extreme conditions [@Lydersen2014]. We detected no interaction between our measure of regional climate conditions just before a fire and our measure of structural variability, but our model cannot capture shorter-duration weather conditions that might lead to the observation of @Lydersen2014. 

## Correlation between covariates and interactions

Unexpectedly, we found a strong interaction between the prefire NDVI at a pixel and its neighborhood mean NDVI. The interaction decreases the overall probability of high-severity wildfire when these two variables covary ($\text{Spearman's }\rho=$ = `r round(preFire_ndvi.neighborhood_mean_NDVI_correlation, 3)`), effectively dampening the dominating effect of prefire NDVI. That is: if both the prefire NDVI and the prefire neighborhood NDVI increase, the probability of high-severity fire doesn't increase quite as much as expected from the additive effect of these two covariates alone and conversely, if both the prefire NDVI and the prefire neighborhood NDVI decrease, the probability of high-severity fire doesn't decrease quite as much as expected from the additive effects of these variables alone. Thus, though the relative effect of prefire NDVI on the probability of high-severity fire is still positive and large, its real-world effect might be more comparable to other modeled covariates when including the negative main effect of neighborhood mean NDVI and the negative interaction effect of prefire NDVI and neighborhood mean NDVI ($\beta_{\text{prefire\_ndvi}}+\beta_{\text{nbhd\_mean\_NDVI}}+\beta_{\text{nbhd\_mean\_NDVI*prefire\_NDVI}}=$ `r round(ci_betas %>% filter(param == "b_preFire_ndvi" & radius == 1) %>% dplyr::select(mean) %>% pull() + ci_betas %>% filter(param == "b_neighborhood_mean" & radius == 1) %>% dplyr::select(mean) %>% pull() + ci_betas %>% filter(param == "b_neighborhood_mean_ndvi.preFire_ndvi" & radius == 1) %>% dplyr::select(mean) %>% pull(), 3)`). When these variables covary, the effect of vegetation density (including the central pixel and the neighborhood) becomes the second strongest effect on the probability of high-severity wildfire, behind the 100-hour fuel moisture.

```{r, results = "hide"}
fig_nums(name = "fig-decoupling-ndvi")
```
![Conceptual diagram of 'decoupling' that sometimes occurs between the central pixel NDVI and the neighborhood mean NDVI. In each of these scenarios, our model results suggest that the probability that the central pixel burns at high severity is higher than expected given the additive effect of the covariates. The left panel depicts the \"hole in the forest\" decoupling, which occurs more frequently, and the right panel depicts the \"isolated patch\" decoupling.](../figures/decoupling-center-neighborhood-ndvi.pdf)

When prefire NDVI and the neighborhood mean NDVI are decoupled, there is an overall effect of increasing the probability of high-severity fire. When prefire NDVI at the central pixel is high and the neighborhood NDVI is low (e.g., an isolated vegetation patch), the probability of high-severity fire is expected to dramatically increase. When prefire NDVI at the central pixel is low and the neighborhood NDVI is high (e.g., a hole in the center of an otherwise dense forest), the probability of high-severity fire at that central pixel is still expected to be fairly high even though there is limited vegetation density there (see `r fig_nums(name = "fig-decoupling-ndvi", display = "cite")`). When these variables do decouple, they tend to do so in the "hole in the forest" case and lead to a greater probability of high-severity fire at the central pixel despite there being limited vegetation density. This can perhaps be explained if the consistently high vegetation density in a local neighborhood-- itself more likely to burn at high-severity-- exerts a contagious effect on the central pixel, raising its probability of burning at high-severity regardless of how much fuel might be there to burn. Texture can also be used to classify vegetation types [@Dobrowski2008], so another possibility is that a decoupled prefire NDVI and neighborhood mean NDVI is characteristic of a particular vegetation type prone to burning at high-severity, such as shrubs [@Thompson2009].

## Caveats

Our approach to remotely measure wildfire severity should work best in denser vegetation such as forests, as the signal of a wildfire in other systems can be invisible in a matter of weeks [@Goodwin2014]. This method would also require calibration with field data in other systems, as some severity metrics (such as RBR and RdNBR) have found limited success in other regions [@Fernandez2018]. The flexibility of our approach should allow for rapid prototyping of novel algorithm configurations to remotely measure severity.

The calibration of our remotely-sensed severity metric to the Composite Burn Index would likely improve with additional ground data. Though we used data from `r total_conifer_cbi_plots` field plots, they represent only `r total_conifer_cbi_fires` fires and `r length(total_conifer_cbi_years)` years (`r paste(total_conifer_cbi_years, collapse = ", ")`).

Our 100-hour fuel moisture measurement captures regional climate conditions on the scale of 4km and across several days, but it misses local weather phenomena such as strong wind events and plume-dominated fire behavior which can greatly influence wildfire severity [@Lydersen2014; @Lydersen2017].

We have captured a coarse measure of forest structural variability. The grain size of our measurement was constrained to the 30m x 30m pixel size of Landast satellite imagery, and the minimum spatial extent of a local vegetation neighborhood that we could capture was 90m x 90m. While we did find that this coarse measure does strongly relate to the probability of high-severity fire, it does not account for fire behavior or spatial pattern forming processes at the individual tree scale. Due to the correlation of NDVI with vegetation density and the spatial constraints on our measurement of forest structural variability as the standard deviation of neighborhood NDVI, we are most likely capturing "intermediate" scales of forest heterogeneity such as the presence and absence of canopy gaps greater than 30m [@Dickinson2014]. Our approach may prove useful at finer scales using different sets of remotely sensed data (e.g., National Agriculture Imagery Program, Sentinel-2), but at a cost of temporal scale [@Dickinson2016]. Additional metrics of variability such as vegetation patch size distributions or non-vegetated gap size distributions [@Malone2018], may also be more tractable using imagery with a finer spatial resolution. 

## Conclusions 

Cloud-based GIS, central image hosting, and integration with powerful classification tools will advance our ability to measure wildfire severity remotely, automatically, consistently, and at broad spatial extents. While our contribution here demonstrates that satisfactory validation with ground-based measurements is possible using simple and well known calculations, we believe that truly groundbreaking abilities to classify wildfire severity would be possible with more open sharing of ground based severity measures. We encourage researchers and managers to make their ground based severity data available with site location (including coordinate reference system) and the fire discovery date for the fire the field data is measuring. 

While the severity of a wildfire in any given place is controlled by many variables, we have presented strong evidence that, across large areas of forest, variable forest structure generally makes yellow pine/mixed-conifer forest in the Sierra Nevada more resistant to this inevitable disturbance. It has been well-documented that frequent, low-severity wildfire maintains forest structural variability. Here, we demonstrate a system-wide reciprocal effect suggesting that greater local-scale variability of vegetation structure makes fire-prone dry forests more resilient to wildfire and may increase the probability of their long-term persistence.





