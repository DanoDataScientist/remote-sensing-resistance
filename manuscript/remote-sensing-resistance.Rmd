---
output: 
  # pdf_document:
  # template: "ms_carpentry/mjk_ms_template.tex"
  # fig_caption: yes
  word_document:
    fig_width: 8
    fig_height: 7
    fig_caption: true
    df_print: kable
    reference_docx: "ms_carpentry/mjk_ms_template_word.docx"
geometry: margin=1in
header-includes: 
- \usepackage{amsmath}
- \usepackage{graphicx}
- \usepackage{setspace}
- \usepackage{mathtools}
- \usepackage[left]{lineno}
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{makecell}
- \usepackage{caption}
- \usepackage{textgreek}
- \linenumbers
- \renewcommand\abstractname{\vspace{-1em}}
# - \captionsetup{width=15cm}

bibliography: "ms_carpentry/remote-sensing-resistance.bib"
csl: https://dl.dropboxusercontent.com/s/3xzxni46ldjzqd1/ecology-letters.csl

title: 'Local variability of vegetation structure increases forest resilience to wildfire'
author:
  - Michael J. Koontz^1,2^, Malcolm P. North^2,3^, Stephen E. Fick^4,5^, Chhaya M. Werner^6^, Andrew M. Latimer^2^

date:
  "^1^Graduate Group in Ecology, University of California, Davis; Davis, CA  \n
  ^2^Department of Plant Sciences, University of California, Davis; Davis, CA  \n
  ^3^Pacific Southwest Research Station, U.S.D.A. Forest Service; Mammoth Lakes, CA  \n
  ^4^U.S. Geological Survey, Southwest Biological Science Center \n
  ^5^Department of Ecology and Evolutionary Bilogy, University of Colorado, Boulder; Boulder, CO \n
  ^6^Center for Population Biology, University of California, Davis; Davis, CA"

abstract: "The long-term peristence of forest ecosystems hinges on their resilience to ongoing disturbance. Measurements of resilience for these valuable ecosystems are critical, but are challenging to capture at relevant scales given a forest's temporal longevity and vast spatial extent. Wildfire disturbance plays a key role in structuring the vegetation of many forests, and vegetation structure can feedback to influence wildfire behavior. High fuel loads and hot, dry conditions are known to increase wildfire-induced tree mortality, but local variability of vegetation structure can enable a forest to withstand wildfire disturbance and retain its essential identity and function-- a hallmark of a resilient system. We investigate the system-wide generality of variable forest structure confering resilience to the yellow pine/mixed-conifer forest of California's Sierra Nevada mountain range. Vegetation structure and disturbance severity can be reliably detected at system-wide spatiotemporal scales using satellite imagery. We use massively parallel cloud computing and texture analysis of Landsat satellite imagery to generate the most comprehensive dataset of wildfire severity and local variability of vegetation structure in this region to date, spanning its entire spatial extent and a 33-year time series of all known wildfires covering greater than 4 hectares. We find that, on a system-wide scale, greater variability in local forest structure reduces the probability of a high severity wildfire. We find the most support for this relationship at the smallest spatial extent of vegetation structure tested, indicating this phenomenon manifests at a local scale. Variable forest structure thus makes yellow pine/mixed-conifer forest in the Sierra Nevada more resistant to inevitable wildfire disturbance on average, and may increase the probability of long-term forest persistence. Efforts to maintain or increase vegetation structure variability in forests, such as allowing fires to burn under some conditions, should be continued."

---
\doublespacing

```{r setup, include=FALSE}
library(here)
library(readr)
library(knitr)
library(kableExtra)
library(captioner)
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

fig_nums <- captioner(prefix = "Fig. ")
table_nums <- captioner(prefix = "Tab. ")
eq_nums <- captioner(prefix = "Eq. ")
```

```{r get_references, results = "hide"}
download.file("https://dl.dropboxusercontent.com/s/2ha48iabtlr5jbo/remote-sensing-resistance.bib", here::here("manuscript/ms_carpentry/remote-sensing-resistance.bib"))
```

```{r source_analyses, results = "hide"}
cbi_models <- read_csv(here::here("data/data_output/cbi_calibration_model_comparison.csv"))

source(here::here("analyses/cbi_summary-stats.R"))
source(here::here("analyses/fire-perims_summary-stats.R"))
source(here::here("analyses/probability-of-high-severity.R"))
source(here::here("analyses/model-comparison.R"))
source(here::here("analyses/prefire-ndvi-neighborhood-mean-ndvi-correlation.R"))

# # This .rds file has the R object name `ss_burned`
# ss_burned <- readRDS(here::here("data/data_output/burned-fire-samples_configured.rds"))
print_cbi_models <- cbi_models
print_cbi_models[, 5:13] <- round(cbi_models[, 5:13], 3)
print_cbi_models <-
  print_cbi_models %>%
  arrange(desc(r2_kfold)) %>%
  mutate(rank = 1:nrow(.)) %>%
  dplyr::select(rank, response, time_window, interpolation, r2_kfold, a, b, c, low_sev, mod_sev, hi_sev)
```

# Introduction

Biological systems comprising heterogeneous elements can retain their fundamental properties in the face of regular disturbance. This ability of a heterogeneous system to absorb disturbances, reorganize, and to persist within a domain of stability with respect to its identity, structure, function, and feedbacks is termed resilience [@Holling1973; @Gunderson2000; @Folke2004; @Walker2004]. Resilience has been demonstrated in complex biological systems characterized by a variety of different types of “heterogeneity” including genetic diversity [@Reusch2005; @Baskett2009; @Agashe2009], species diversity [@Tilman1994; @Chesson2000; @Cadotte2013], functional diversity [@Gazol2016], topoclimatic complexity [@Ackerly2010; @Lenoir2013], and temporal environmental variation [@Questad2008]. An emerging paradigm in forest ecology is that spatial variability in the structure of vegetation on the landscape can confer resilience to disturbances such as wildfire, drought, and insect outbreaks [@Stephens2008; @North2009; @Virah-Sawmy2009]. In California, increasing temperature coupled with increasing drought frequency exacerbate water stress on treesduring “hotter droughts” [@ParkWilliams2012; @Millar2015]. Further, a century of fire suppression policy has led to drastic densification and homogenization of forest structure in the Sierra Nevada [@North2015]. Wildfire regimes have changed in these forests such that fires are bigger and burn more at higher severity [@Miller2007; @Cansler2014; @Harvey2016c]. Changes in wildfire disturbance regimes are particularly suited to catalyze catastrophic shifts in ecosystems because of their feedback with spatial forest variability at multiple scales. Thus, western North American forests are experiencing novel, “unhealthy” conditions (*sensu* @Raffa2009) that are liable to upset the feedbacks between forest structure and pattern-forming ecological disturbances that historically stabilized the system and made it resilient [@Raffa2008; @Millar2015]. Forests are of high management priority [@Hansen2013; @Crowther2015; @Millar2015; @Trumbore2015], thus it is critical to understand the mechanisms underlying the effect of spatial variability in forest structure on forest resilience. 

Resilience of forest ecosystems is fundamentally challenging to quantify because forests comprise long-lived species, span large geographic extents, and are affected by disturbances at a very broad range of spatial scales. The ease or difficulty with which a disturbance changes a system's state is resistance, and it is a key component of resilience [@Walker2004]. In yellow pine/mixed-conifer forests of California's Sierra Nevada mountain range, wildfire disturbance alters the system state at landscape scales with the deaths of overstory trees. Thus, a more resistant forest system should generally experience lower tree mortality when a fire inevitably occurs.

Wildfire severity describes the effect of a wildfire on an ecosystem-- often the amount of vegetation mortality [@Sugihara2006]. Wildfire severity can be measured by comparing pre- and post-fire satellite imagery for a specific area, but this usually requires considerable manual effort for image collation and processing, followed by calibration with field data [@Miller2007; @Miller2009a; @DeSantis2010; @Cansler2012; @Veraverbeke2013; @Parks2014; @Prichard2014; @Edwards2018; @Fernandez2018]. Efforts to measure severity across broad spatial extents, such as the Monitoring Trends in Burn Severity project [@Eidenshink2007], are unsuitably subjective for rigourous scientific analysis though they serve their intended management purpose admirably [@Kolden2015]. Automated efforts to remotely assess wildfire have arisen, but they tend to focus on more aggregate measures of wildfire such as whether an area burned or the probability that it burned rather than the severity of the burn (@Bastarrika2011; @Goodwin2014; @Boschetti2015; @Hawbaker2017 but see @Reilly2017 and @Parks2018). Here, we present a method to automate the measurement of wildfire severity using minimal user inputs: a geometry of interest (a wildfire perimeter or a field plot location) and an alarm date (the date the fire began). This information is readily available in many fire-prone areas (such as California, via the Fire and Resource Assessment Program; http://frap.fire.ca.gov/projects/fire_data/fire_perimeters_index) or could be derived using existing products (such as the Landsat Burned Area Essential Climate Variable product described in @Hawbaker2017). 

Vegetation characteristics such as canopy density [@Rouse1973; @Young2017], moisture content [@Asner2015], insect attack [@Nasi2015], and even functional diversity [@Asner2017] can be measured using remotely-sensed imagery. Texture analysis of imagery can quantify ecologically relevant local environmental heterogeneity across broad spatial extents [@Wood2012]. Developed for image classification and computer vision, texture analysis characterizes each pixel in an image by a summary statistic of its neighboring pixels [@Haralick1973; @Conners1984]. The value of each pixel represents a measure of local heterogenity within a predefined moving window, and the heterogeneity measurement itself varies across each pixel in the image. Ecologists have successfully used texture measurements to augment predictions of ecosystem properties such as species richness (@Huang2014; @Stein2014a; @Tuanmu2015 but see @Culbert2012).

### Creation and maintenance of forest spatial variability

Forest structure is defined by the size and distribution of trees on the landscape. Differences in tree crown heights characterize vertical structure, while differences in the rooting locations of trees characterizes horizontal structure [@North2009]. Competition for light, water, and other resources can yield aggregations of trees within favorable microsites, as well as areas containing trees that are more widely spaced trees where resources are more limiting [@Clyatt2016]. Demographic processes of dispersal, recruitment, and mortality affect forest structure by adding or subtracting whole trees. Reciprocally, forest structure can also influence these pattern-forming processes; for example, vegetation overstory density alters microclimate and changes understory tree demographic rates [@Larson2012; @DeFrenne2013; @Ford2013]. The stabilizing effects of these reciprocal processes in forests are hallmarks of a resilient system [@Folke2004]. In the Sierra Nevada range of California, one of the strongest feedbacks between forest structure and pattern-generating ecological process is wildfire, which affects hundreds of thousands to millions of hectares of forested area per year in the Sierra Nevada [@Larson2012; @ParkWilliams2012; @Millar2015]. 

Wildfire interacts dynamically with the forest structure [@Westerling2006; @ParkWilliams2012; @Larson2012]. Wildfire can affect future forest structure by changing demographic rates of individual trees (e.g. increasing growth or germination via increasing light or nitrogen availability), but its most lasting impact to forest structure is in the pattern of killed trees left in its wake [@Larson2012]. Wildfire behavior is inherently complex and is influenced by local weather, topography, and heterogeneous fuel conditions created by departures from the average fire return interval at any particular place [@Sugihara2006; @Collins2010]. For instance, high tree density and presence of “ladder fuels” in the understory increase the probability of crown fire that kills a high proportion of trees [@Agee2005; @Stephens2008]. A heterogeneous forest can largely avoid overstory tree mortality because a reduced amount of accumulated ladder fuel decreases its ability to get into the crown (where mortality is more likely to result), because wide spacing between tree clumps interrupts high severity fire spread across the landscape, and because small tree clumps with fewer trees don’t facilitate self-propagating fire behavior [@Graham2004; @Scholl2010]. In forests with relatively intact fire regimes and heterogeneous stand conditions such as in the Jeffrey pine/mixed-conifer forests of the Sierra San Pedro Mártir in Baja, California, there tends to be reduced vegetation mortality after wildfires compared to fire-suppressed forests [@Stephens2008]. Thus, forests with heterogeneous structure are predicted to persist due to their resistance to inevitable wildfire disturbance [@Graham2004; @Moritz2005; @Stephens2008]. However, it is unclear whether this is true at broad spatial extents, nor is it resolved at what scale variability in forest structure is meaningful for resilience [@Kotliar1990]. 

We use Landsat satellite data and a new image processing approach to calculate wildfire severity for all Sierra Nevada wildfires since 1984 that burned in yellow pine/mixed-conifer forest and covered more than 4 hectares. We calibrate 56 configurations of our algorithmic approach to groud-based wildfire severity measurments, and select the best performing severity metric to generate a comprehensive, system-wide severity dataset. We pair these data with image texture analysis to ask: does spatial variability in forest structure increase the resilience of California yellow pine/mixed-conifer forests by reducing the severity of wildfires? Further, we ask whether the influence of structural variability on fire severity depends on topographic, fire weather, or other fuel conditions.

# Methods

```{r, results = "hide"}
fig_nums(name = "fig-study-geographic-setting")
```

![Geographic setting of the study. A) Location of yellow pine/mixed-conifer forests as designated by the Fire Return Interval Departure (FRID) product which, among other things, describes the potential vegetation in an area based on the pre-Euroamerican settlement fire regime. B) Locations of all fires covering greater than 4 hectares that burned in yellow pine/mixed-conifer forest between 1984 and 2017 in the Sierra Nevada mountain range of California according to the State of California Fire Resource and Assessment Program database, the most comprehensive database of fire perimeters of its kind. Colors indicate how many fire perimeters overlapped a given pixel within the study time period. C) (red) Locations of composite burn index (CBI) ground plots used to calibrate the remotely sensed measures of severity. (black) Locations of random samples drawn from 972 unique fires depicted in panel B that were in yellow pine/mixed-conifer forest as depicted in panel A, and which were designated as "burned" by exceeding a threshold relative burn ratio (RBR) determined by calibrating the algorithm presented in this study with ground based CBI measurements.](../figures/study-geographic-setting.pdf)

## Study system

Our study assesses the effect of vegetation structure on wildfire severity in the Sierra Nevada mountain range of California in yellow pine/mixed-conifer forests (`r fig_nums(name = "fig-study-geographic-setting", display = "cite")`). This system is dominated by a mixture of conifer species including ponderosa pine (*Pinus ponderosa*), sugar pine (*Pinus lambertiana*), incense-cedar (*Calocedrus decurrens*), Douglas-fir (*Pseudotsuga menziesii*), white fir (*Abies concolor*), and red fir (*Abies magnifica*) as well as shrubs [@Stephens2004; @Collins2015; @Safford2017]. We considered "yellow pine/mixed-conifer forest" to be all area designated as a yellow pine, dry mixed conifer, or moist mixed conifer pre-settlement fire regime (PFR) in the USFS Fire Return Interval Departure database (https://www.fs.usda.gov/detail/r5/landmanagement/gis/?cid=STELPRDB5327836). We used the PFR to define our system because it reflects potential vegetation and is less sensitive to recent land cover change [@Steel2018]. We considered the Sierra Nevada region to be the area within the Sierra Nevada Foothills, the High Sierra Nevada, and the Tehachapi Mountain Area Jepson ecoregions. 

The historical range of variation of this system is characterized by relatively low tree density (mean of 143.8 trees ha^-1^), open canopy (mean of 34.4% canopy cover), and heterogeneous forest struture with highly variable tree density, large and small canopy gaps, and clumps of vegetation dominated by large trees [@North2012; @Safford2017]. The heterogeneous forest structure manifested at scales ranging from less than one hectare to tens of thousands of hectares, and was maintained by topographic effects on average water availability and frequent, low-severity fire [@North2012; @Steel2015; @Collins2015]. Prior to the era of Euroamerican fire suppression, approximately 5 to 18% of the yellow pine/mixed-conifer system burned annually with an average fire return interval in any given place of about 11 years [@North2012a; @Steel2015; @Safford2017]. The frequent fire prevented the accumulation of fuel on the ground and reduced the potential for high intensity subsequent fires [@Steel2015].

As a result of 150 years of effective fire suppression in this system, overall tree density has increased by a factor of 2.75, canopy cover has increased by 25-49%, and average tree size has decreased by 25 to 40% reflecting a dramatic increase in small trees and loss of large trees [@Dolanc2014; @McIntyre2014; @Stephens2015; @Safford2017]. This forest infilling has homogenized forest structure on fine scales with the loss of canopy gaps and the fusion of small tree clumps into larger continuous canopy [@Lydersen2013]. The dense fuel loading and anthropogenic climate change are leading to larger fires and larger patches of complete tree mortality, which homogenizes the forest structure on landscape scales [@Westerling2006; @Miller2012a; @Abatzoglou2016; @Steel2018].

## A new approach to remotely sensing wildfire severity

Forest vegetation characteristics and wildfire severity can be reliably detected at long temporal and vast spatial scales from sensors aboard the Landsat series of satellites [@Eidenshink2007; @Miller2007]: the Thematic Mapper (TM; Landsat 4 and 5), Enhanced Thematic Mapper Plus (ETM+; Landsat 7), and Operational Land Imager (OLI; Landsat 8). Recent advances in radiometric correction post-processing can compensate for various atmospheric distortions and generate more accurate measurements of surface reflectance in narrow wavelength bands spanning the electromagnetic spectrum [@Masek2006; @Vermote2016; @USGSledaps2017; @USGSlasrc2017]. Landsat satellites image the entire Earth approximately every 16-days and repeat images of the same area are geometrically coregistered such that overlapping pixels correspond to the same area on the ground. We used Google Earth Engine, a massively parallel cloud-based geographic information system and image hosting platform, for all image collation and processing [@Gorelick2017].

To minimize bias in assessing general features of wildfire in this system, it is critical to include small fires in analyses. For instance, Miller and Safford (in prep) found that the modern average fire size was greater than natural range of variation in average fire size in Sierra Nevada yellow pine/mixed-conifer forest when only comparing fires covering greater than a minimum threshold size. However, they found that the modern average fire size was less than the natural range of variation in average fire size when comparing all fires with no size cutoff (Miller and Safford, \emph{in prep}). A key driver of wildfire size is whether initial suppression efforts were successful [@Calkin2005]. Under fire suppression management, 98% of wildfires are extinguished before they reach 120ha [@Calkin2005]. The 2% of fires that escape initial suppression often burn in extreme fuel and weather conditions, and these fires constitute 97.5% of the total area burned in this system. Thus, suppression activity exerts a bias on wildfire behavior, whereby the largest fires may not be representative of typical fire behavior though they make up the vast majority of burned area [@Safford2017]. 

We calculated wildfire severity for the most comprehensive digital record of fire perimeters in California: The California Department of Forestry and Fire Protection, Fire and Resource Assessment Program (FRAP) fire perimeter database (http://frap.fire.ca.gov/projects/fire_data/fire_perimeters_index) which includes all known fires that covered more than 4 hectares. Using this database, we quantified severity within each perimeter of `r total_conifer_fires` wildfires in the Sierra Nevada yellow pine/mixed-conifer forest that burned between 1984 and 2017. Our approach more than doubles the number of fires with severity measurements in this system compared to the current standard, which only includes fires covering greater than 80 ha [@Miller2007; @Miller2012; @Miller2012a;  @Steel2018].

### Fetching and processing pre- and postfire imagery

```{r, results = "hide"}
fig_nums(name = "fig-image-acquisition-algorithm")
```

We leveraged the cloud-based data catalog, the large parallel processing system, and the distribution of computation tasks in Google Earth Engine to enable rapid high-throughput analyses using millions of gigabytes of earth observation data [@Gorelick2017]. Our programmatic assessment of wildfire severity across the `r total_conifer_fires` Sierra Nevada yellow pine/mixed-conifer fires in the FRAP perimeter database, which required fetching thousands of Landsat images and performing dozens of calculations across them, was automated and took less than an hour to complete.

All Landsat imagery was fetched by "scene"-- the atomic unit of image data in the Landsat collection representing an area on the Earth's surface approximately 170 km long by 183 km wide. For each feature, a collection of Landsat scenes was fetched both before and after the fire by defining a date range to search for imagery. The date range for prefire imagery started one day before each feature's alarm date and extended backward in time by a user-defined time window. The date range for postfire imagery was exactly one year after the date range for the prefire search (i.e., one year after the day before the fire, extending backward in time by the same time window). We tested 4 time windows: 16, 32, 48, or 64 days which were chosen to ensure that at least 1, 2, 3, or 4 Landsat images, taken on a 16-day interval, were captured by the date ranges (`r fig_nums(name = "fig-image-acquisition-algorithm", display = "cite")`).

![Schematic for how Landsat imagery was assembled in order to make comparisons between pre- and post-fire conditions. This schematic depicts a 64-day window of image collation prior to the fire which comprise the pre-fire image collection. A similar, 64-day window collection of imagery is assembled one year after the pre-fire image collection.](../figures/image-acquisition-algorithm.pdf)

The Landsat archive was filtered to generate a prefire image collection comprising only the Landsat scenes depicting some part of the feature geometry and within the prefire date range. A postfire image collection was similarly generated by filtering the Landsat archive by the postfire date range and the feature geometry. The Landsat archive we filtered included imagery from Landsat 4, 5, 7, and 8, so each pre- and postfire image collection may contain a mix of scenes from different satellite sources to enhance coverage.

```{r eq_ndvi, results = "hide"}
eq_nums(name = "eq-ndvi")
```

```{r eq_ndmi, results = "hide"}
eq_nums(name = "eq-ndmi")
```

```{r eq_nbr, results = "hide"}
eq_nums(name = "eq-nbr")
```

```{r eq_nbr2, results = "hide"}
eq_nums(name = "eq-nbr2")
```

For each image in the pre- and postfire image collections, we masked pixels that were not clear (i.e., clouds, cloud shadows, snow, and water) and calculated standard indices that capture vegetation cover and fire effects such as charring. Normalized difference vegetation index (NDVI; `r eq_nums(name = "eq-ndvi", display = "cite")`) correlates with vegetation density, canopy cover, and leaf area index (LAI) [@Rouse1973]. Normalized difference moisture index (NDMI; `r eq_nums(name = "eq-ndmi", display = "cite")`) correlates with similar vegetation characteristics as NDVI, but doesn't saturate at high levels of foliar biomass [@Gao1996, @Huesca2016]. Normalized burn ratio (NBR; `r eq_nums(name = "eq-nbr", display = "cite")`) and normalized burn ratio version 2 (NBR2; `r eq_nums(name = "eq-nbr2", display = "cite")`) respond strongly to fire effects on vegetation [@Lopez1991; @Key2006; @USGSlasrc2017; @USGSledaps2017; @Hawbaker2017].

(@eq-ndvi) $\label{eq-ndvi}
ndvi = \mathopen(nir - red\mathclose) / \mathopen(nir + red\mathclose)$

(@eq-ndmi) $\label{eq-ndmi}
ndmi = \mathopen(nir - swir1\mathclose) / \mathopen(nir + swir1\mathclose)$

(@eq-nbr) $\label{eq-nbr}
nbr = \mathopen(nir - swir2\mathclose) / \mathopen(nir + swir2\mathclose)$

(@eq-nbr2) $\label{eq-nbr2}
nbr2 = \mathopen(swir1 - swir2\mathclose) / \mathopen(swir1 + swir2\mathclose)$

Where $nir$ is the near infrared band (band 4 on Landsat 4, 5, and 7; band 5 on Landsat 8) and $red$ is the red band (band 3 on Landsat 4, 5, and 7; band 4 on Landsat 8), $swir1$ is the first short wave infrared band (band 5 on Landsat 4, 5, and 7; band 4 on Landsat 8), $swir2$ is the second short wave infrared band (band 7 on Landsat 4, 5, 7, and 8)

We composited each prefire image collection into a single prefire image using a median reducer, which calculated the median of the unmasked values on a per-pixel basis across the stack of images in the prefire collection. We similarly composited the postfire image collection into a single postfire image. Composite pre- and postfire images can be successfully used to measure wildfire severity instead of using raw, individual scenes [@Parks2018].

### Calculating wildfire severity

```{r eq_dindex, results = "hide"}
eq_nums(name = "eq-dindex")
```

There is some debate about the most useful measure of remotely-sensed wildfire severity [@Miller2012a; @Parks2014; @Hawbaker2017], so we calculated the most commonly used metrics to validate against ground-based data. We calculated remotely-sensed wildfire severity using the relative burn ratio (RBR) [@Parks2014], the delta normalized burn ratio (dNBR) [@Eidenshink2007; @Miller2007], the relative delta normalized burn ratio (RdNBR) [@Miller2007], the delta normalized burn ratio 2 (dNBR2) [@Hawbaker2017], the relative delta normalized burn ratio 2 (RdNBR2), and the delta normalized difference vegetation index (dNDVI) [@Eidenshink2007]. Following the success of the RdNBR metric in other studies, we also calculate an analogous metric using NDVI-- the relative delta normalized difference vegetation index (RdNDVI).

We calculated the delta severity indices (dNBR, dNBR2, dNDVI) by subracting the respective postfire indices from the prefire indices (NBR, NBR2, and NDVI) without multiplying by a rescaling constant (e.g., we did not multiply the result by 1000 as in @Miller2007; `r eq_nums("eq-dindex", display = "cite")`). Following @Reilly2017, we chose not to correct the delta indices using a phenological offset value (typically calculated as the delta index in homogenous forest patch outside of the fire perimeter), as our approach implicitly accounts for phenology by incorporating multiple cloud-free images across the same time window both before the fire and one year later.

(@eq-dindex) $\label{eq-dindex}
dI = I_{\text{prefire}} - I_{\text{postfire}}$

```{r eq_rdindex, results = "hide"}
eq_nums(name = "eq-rdindex")
```

We calculated the relative delta severity indices, RdNBR and RdNDVI, by scaling the respective delta indices (dNBR and dNDVI) from `r eq_nums(name = "eq-rdindex", display = "cite")` by a square root transformation of the absolute value of the prefire index:

(@eq-rdindex) $\label{eq-rdindex}
RdI = \frac{dI}{\sqrt{\mathopen|I_{\text{prefire}}\mathclose|}}$


```{r eq_rbr, results = "hide"}
eq_nums(name = "eq-rbr")
```

We calculated the relative burn ratio (RBR) following @Parks2014 using `r eq_nums(name = "eq-rbr", display = "cite")`:

(@eq-rbr) $\label{eq-rbr}
RBR = \frac{dNBR}{NBR_{\text{prefire}} + 1.001}$


```{r, results = "hide"}
fig_nums(name = "fig-pre-post-rbr")
```

Example algorithm outputs are shown in `r fig_nums(name = "fig-pre-post-rbr", display = "cite")`.

![Example algorithm outputs for the Hamm Fire of 1987 (top row) and the American Fire of 2013 (bottom row) showing: prefire true color image (left column), postfire true color image (center column), relative burn ratio (RBR) calculation using a 48-day image collation window before the fire and one year later. For visualization purposes, these algorithm outputs have been resampled to a resolution of 100m x 100m from their original resolution of 30m x 30m. Data used for analyses were sampled from the outputs at the original resolution.](../figures/pre-post-rbr.pdf)

### Calibrating remotely-sensed wildfire severity with field-measured wildfire severity

We calibrated our remotely-sensed measure of wildfire severity with `r total_conifer_plots` field measures of overstory tree mortality from two previously published studies [@Zhu2006; @Sikkink2013] (`r fig_nums(name = "fig-study-geographic-setting", display = "cite")`). The Composite Burn Index (CBI) is a metric of vegetation mortality across several vertical vegetation strata [@Key2006] and has a long history of use as a standard for calibrating remotely-sensed severity data [@Miller2007; @Miller2009a; @Cansler2012; @Parks2014; @Prichard2014; @Parks2018]. The CBI ranges from 0 (no fire impacts) to 3 (very high fire impacts) and is an integrated measure of vegetation mortality, scorching, and resprouting assessed in different vertical forest strata within a 30m diameter field plot [@Key2006]. Following @Miller2007, @Miller2009a, @Parks2014, and @Parks2018, we fit a non-linear model to each remotely-sensed severity metric of the following form:

```{r eq-cbi-calibration, results = "hide"}
eq_nums(name = "eq-cbi-calibration")
```

(@eq-cbi-calibration) $\label{eq-cbi-calibration}
\text{remote\_severity} = \beta_0 + \beta_1 e^{\beta_2 \text{cbi\_overstory}}$

We fit the model in `r eq_nums(name = "eq-cbi-calibration", display = "cite")` for all 7 of our remotely-sensed severity metrics (RBR, dNBR, RdNBR, dNBR2, RdNBR2, dNDVI, RdNDVI) using 4 different time windows from which to collate satellite imagery (16, 32, 48, and 64 days). Following @Cansler2012, @Parks2014, and @Parks2018, we used interpolation to extract remotely-sensed severity at the locations of the CBI field plots to better align remote and field measures of severity. We extracted remotely-sensed severity values using both bilinear interpolation, which returns a severity value weighted by the 4 pixel values nearest to the CBI plot location, and bicubic interpolation, which returns a severity value weighted by the 16 pixel values nearest to the CBI plot location. In total, we fit 56 models (7 severity measures, 4 time windows, 2 interpolation methods) and performed five-fold cross validation using the `modelr` and `purrr` packages in R [@RCoreTeam2018]. To compare goodness of model fits with @Miller2007, @Miller2009a, and @Parks2014, we report the average R^2^ value from the five folds for each of the 56 models but note that R^2^ for non-linear regressions do not have the same interpretation that they do for linear regression (i.e., R^2^ can be greater than 1 for non-linear regression, so it can't be interpreted as the proportion of variation explained by the model). 

## Remote sensing other conditions

### Variability of vegetation

```{r, results = "hide"}
fig_nums(name = "fig-heterogeneity-raster")
```

We used texture analysis to calculate a remotely-sensed measure of local forest variability [@Haralick1973; @Tuanmu2015]. Within a moving square neighborhood window with sides of 90m, 150m, 210m, and 270m (corresponding to a moving neighborhood window of $`r round(90^2 / 10000, 2)`$ ha, $`r round(150^2 / 10000, 2)`$ ha, $`r round(210^2 / 10000, 2)`$ ha, and $`r round(270^2 / 10000, 2)`$ ha), we calculated forest variability for each pixel as the standard deviation of the NDVI values of its neighbors (not including itself) (See `r fig_nums(name = "fig-heterogeneity-raster", display = "cite")`). NDVI correlates well with foliar biomass, leaf area index, and vegetation density [@Rouse1973], so a higher standard deviation of NDVI within a given local neighborhood corresponds to more of a mixture of dense patches and sparsely vegetated patches (see `r fig_nums(name = "fig-heterogeneity-raster", display = "cite")`).

![Example of homogenous forest (top row) and heterogenous forest (bottom row) with the same mean NDVI values (~0.6). Each column represents forest structural variability measured using a different neighborhood size. \label{fig-heterogeneity-raster}](../figures/heterogeneity-demo-raster.pdf)

### Topographic conditions

Elevation data were sourced from the Shuttle Radar Topography Mission [@Farr2007], a 1-arc second digital elevation model. Slope and aspect were extracted from the digital elevation model. Per-pixel topographic roughness was calculated as the standard deviation of elevation values within a the same kernel sizes as those used for variability in forest structure  (90m, 150m, 210m, and 270m on a side and not including the central pixel). Some work has shown that terrain ruggedness [@Holden2009], and particularly coarser-scale terrain ruggedness [@Dillon2011], is an important predictor of wildfire severity.

```{r eq-potential-annual-heat-load, results = "hide"}
eq_nums(name = "eq-potential-annual-heat-load")
```

We used the digital elevation model to calculate the potential annual heat load (`r eq_nums(name = "eq-potential-annual-heat-load", display = "cite")` at each pixel, which is an integrated measure of latitude, slope, and a folding transformation of aspect about the northeast-southwest line, such that northeast becomes 0 radians and southwest becomes $\pi$ radians (@McCune2002 with correction in @McCune2007):

(@eq-potential-annual-heat-load) $\begin{aligned}
\label{eq-potential-annual-heat-load}
aspect_{folded} &= \mathopen| \pi - \mathopen| aspect - \frac{5\pi}{4}\mathclose| \mathclose| \\
log(pahl) &= \begin{aligned}
&-1.467 + \\
&1.582 * cos(latitude) cos(slope) - \\
&1.5 * cos(aspect_{folded}) sin(slope) sin(latitude) - \\
&0.262 * sin(lat) sin(slope) + \\
&0.607 * sin(aspect_{folded}) sin(slope) \\
\end{aligned}
\end{aligned}$

Where $pahl$ is the potential annual heat load, $aspect_{folded}$ is a transformation of aspect in radians, and both $latitude$ and $slope$ are extracted from a digital elevation model with units of radians.

### Moisture conditions

The modeled 100-hour fuel moisture data were sourced from the gridMET product, a gridded meteorological product with a daily temporal resolution and a 4km x 4km spatial resolution [@Abatzoglou2013a]. For our purposes, we calculated 100-hour fuel moisture as the median 100-hour fuel moisture for the 3 days prior to the fire. The 100-hour fuel moisture is a correlate of the regional temperature and moisture which integrates the relative humidity, the length of day, and the amount of precipitation in the previous 24 hours. Thus, this measure is sensitive to multiple hot dry days across the 4km x 4km spatial extent of each grid cell, but not to diurnal variation in relative humidity.  

### Remote samples

Approximately 100 random points were selected within each FRAP fire perimeter in areas designated as yellow pine/mixed-conifer forest and the values of wildfire severity as well as the values of each covariate were extracted at those points. The random sampling amounted to `r total_conifer_samps` total samples across `r total_conifer_fires` fires.

## Modeling the effect of forest variability on severity

We used the Relative Burn Ratio (RBR) calculated using bicubic interpolation within a 48-day window to derive our response variable for analyses of forest structural variability, as it showed the best correspondence to field severity data measured as average R^2^ in the 5-fold cross validation. To quantify resilience, we were most interested in analyzing when the wildfire disturbance resulted in complete or near complete tree morality-- when a particular area burned at high severity. Using the non-linear relationship between RBR and CBI from the best performing calibration model, we calculated the threshold RBR that corresponds to "high severity" (CBI value of 2.25). If the severity at a remote sample point was greater than this threshold, the point was scored as a 1. We used the mixed effects logistic regression model described in `r eq_nums(name = "eq-severity-model", display = "cite")` to assess the effect of variability in forest structure on the probability of high severity wildfire. We scaled all continuous predictor variables, and treated each individual fire as having a random intercept effect.

(@eq-severity-model) $\begin{aligned}
\label{eq-severity-model}
severity_{i, j} &\sim Bern(\phi_{i,j}) \\
logit(\phi_{i,j}) &= 
\begin{aligned}
& \beta_0 + \\
& \beta_{\text{nbhd\_stdev\_NDVI}} * \text{nbhd\_stdev\_NDVI}_i + \\
& \beta_{\text{prefire\_NDVI}} * \text{prefire\_NDVI}_i + \\
& \beta_{\text{nbhd\_mean\_NDVI}} * \text{nbhd\_mean\_NDVI}_i + \\
& \beta_{\text{fm100}} * \text{fm100}_i + \\
& \beta_{\text{pahl}} * \text{pahl}_i + \\
& \beta_{\text{topographic\_roughness}} * \text{topographic\_roughness}_i + \\
& \beta_{\text{nbhd\_stdev\_NDVI*fm100}} * \text{nbhd\_stdev\_NDVI}_i * \text{fm100}_i + \\
& \beta_{\text{nbhd\_stdev\_NDVI*prefire\_NDVI}} * \text{nbhd\_stdev\_NDVI}_i * \text{prefire\_NDVI}_i + \\
& \beta_{\text{nbhd\_stdev\_NDVI*nbhd\_mean\_NDVI}} * \text{nbhd\_stdev\_NDVI}_i * \text{nbhd\_mean\_NDVI}_i + \\
& \beta_{\text{nbhd\_mean\_NDVI*prefire\_NDVI}} * \text{nbhd\_mean\_NDVI}_i * \text{prefire\_NDVI}_i + \\
& \gamma_j
\end{aligned}
\\
\gamma_j &\sim \mathcal{N}(0, \sigma_{\text{fire}})
\end{aligned}$

Each neighborhood size (90m x 90m, 150m x 150m, 210m x 210m, and 270m x 270m) was substituted in turn for the neighborhood standard deviation of NDVI, neighborhood mean NDVI, and terrain ruggedness covariates to generate a candidate set of 4 models. To assess the scale at which the forest structure variability effect manifests, we compared the 4 candidate models based on different neighborhood sizes using leave-one-out cross validation (LOO cross validation) [@Vehtari2016].  We inferred that the neighborhood size window used in the best-performing model reflected the scale at which the forest structure variability effect had the most support. 

## Statistical software and data availability

We used `R` for all statistical analyses [@RCoreTeam2018]. We used the `brms` package to fit mixed effects models in a Bayesian framework which implements the No U-Turn Sampler (NUTS) extension to the Hamiltonian Monte Carlo algorithm [@Hoffman2014; @Burkner2017]. We used 4 chains with 3000 samples per chain (1500 warmup samples and 1500 posterior samples) and chain convergence was assessed for each estimated parameter by ensuring Rhat values were less than or equal to 1.01 [@Burkner2017].

# Results

## A new approach to remotely sensing wildfire severity

We found that the remotely sensed relative burn ratio (RBR) metric of wildfire severity measured across a 48 day interval prior to the wildfire alarm date correlated best with ground based composite burn index (CBI) measurements of severity (5-fold cross validation $R^2 =$ `r print_cbi_models$r2_kfold[1]`; `r fig_nums(name = "fig-cbi-calibration", display = "cite")`; Supp. Table 1). Our method to calculate remotely sensed severity using automated Landsat image fetching performs as well or better than most other reported methods that use hand-curation of Landsat imagery (see review in @Edwards2018). Further, several combinations of remotely sensed severity metrics, time windows, and interpolation methods validate well with the ground based severity metrics, including those based on NDVI which is calculated using reflectance in shorter wavelengths than those typically used for measuring severity (`r fig_nums(name = "fig-cbi-calibration", display = "cite")`). The top three configurations of our remotely sensed severity metric are depicted in `r fig_nums(name = "fig-cbi-calibration", display = "cite")`.

```{r, results = "hide"}
fig_nums(name = "fig-cbi-calibration")
```

![Three top performing remotely-sensed severity metrics based on 5-fold cross validation (relative burn ratio, 48-day window, bicubic interpolation; relative delta normalized burn ratio, 32-day window, bilinear interpolation; and relative delta normalized difference vegetation index, 48-day window, bilinear interpolation) calculated using new automated image collation algorithms, calibrated to `r total_conifer_plots` field measures of fire severity (composite burn index). See Supplemental Table 1 for performance of all tested models.](../figures/remote-sensed-severity-calibration.pdf)

```{r, results = "hide", eval = FALSE}
table_nums(name = "table-cbi-models")
```

```{r cbi_models_table, results = "hide", eval = FALSE}
knitr::kable(print_cbi_models,
             # format = "latex",
             longtable = TRUE,
             booktabs = TRUE,
             caption = "Comparison of models used to validate and calibrate remotely sensed wildfire severity with ground based composite burn index (CBI) severity sorted in descending order by the $R^2$ value from a 5-fold cross validation. A total of 56 models were tested representing all possible combinations of 7 different measures of wildfire severity (RBR, dNBR, dNBR2, RdNBR, RdNBR2, dNDVI, and RdNDVI), 4 different time windows in which Landsat imagery was acquired and summarized with a median reducer on a pixel-by-pixel basis (16 days, 32 days, 48 days, and 64 days), and two different interpolation methods (bilinear and bicubic). The three parameters (\\textbeta\\textsubscript{0}, \\textbeta\\textsubscript{1}, and \\textbeta\\textsubscript{2}) from the nonlinear model fit described in Eq. \\ref{eq-cbi-calibration} are reported. For each model, the value of the remotely sensed wildfire severity measurement corresponding to the lower bounds of 3 commonly used categories of severity are reported ('low' corresponds to a CBI value of 0.1, 'mod' corresponds to a CBI value of 1.25, and 'high' corresponds to a CBI value of 2.25)",
             caption.short = "Comparison of models used to validate and calibrate remotely sensed wildfire severity with CBI severity",
             escape = FALSE,
             col.names = c("Rank", "\\makecell[c]{Severity\\\\measure}", "\\makecell[c]{Time\\\\window}", "Interpolation", "\\makecell[c]{k-fold\\\\$R^2$}", "\\makecell[c]{\\textbeta\\textsubscript{0}}", "\\makecell[c]{\\textbeta\\textsubscript{1}}", "\\makecell[c]{\\textbeta\\textsubscript{2}}", "low", "mod", "high")) %>%
  kable_styling(latex_options = c("repeat_header"))
```

```{r param_estimates_latex, eval = FALSE}
knitr::kable(ci_betas_print_table,
             # format = "latex",
             caption = "Model parameter estimates for different neighborhood sizes.",
             caption.short = "Model parameter estimates",
             escape = FALSE,
             col.names = c("Coefficient", "\\makecell[c]{90m x 90m\\\\neighborhood}", "\\makecell[c]{150m x 150m\\\\neighborhood}", "\\makecell[c]{210m x 210m\\\\neighborhood}", "\\makecell[c]{270m x 270m\\\\neighborhood}"))
```

```{r param_estimates_word, eval = FALSE}
knitr::kable(ci_betas_print_table_simple,
             # format = "latex",
             caption = "Model parameter estimates for different neighborhood sizes.",
             caption.short = "Model parameter estimates",
             escape = FALSE,
             col.names = c("Coefficient", "90m x 90m neighborhood", "150m x 150m neighborhood}", "210m x 210m neighborhood", "270m x 270m neighborhood"))
```

Based on these model comparisons, we used the relative burn ratio (RBR) calculated using a 48-day time window before the fire and bicubic interpolation as our metric of severity. We created the boolean response variable representing whether the sampled point burned at high severity or not by determining whether the RBR exceeded `r print_cbi_models$hi_sev[1]`, the threshold for high severity derived using the non-linear relationship in `r eq_nums(name = "eq-cbi-calibration", display = "cite")` (`r fig_nums(name = "fig-cbi-calibration", display = "cite")`). 

## Neighborhood size effect

```{r, results = "hide"}
table_nums(name = "table-ic-table")
```

```{r ic_print_table}
knitr::kable(ic_print_table,
             # format = "latex",
             caption = "Comparison of four models described in Eq. \\ref{eq-severity-model} using different neighborhood sizes for calculating forest structural variability (standard deviation of NDVI within the neighborhood), neighborhood mean NDVI, and topographic roughness. LOO is calculated as -2 times the expected log pointwise predictive density (elpd) for a new dataset [@Vehtari2016]. The Bayesian R^2^ is \"data-based estimate of the proportion of variance explained for new data\" conditional on the model [@Gelman2018].",
             caption.short = "Comparison of models using different neighborhood size windows to assess scale at which heterogeneity effect manifests",
             escape = FALSE,
             col.names = c("\\makecell[c]{Model}", "\\makecell[c]{Neighborhood size for\\\\variability measure}", "\\makecell[c]{LOO\\\\(-2*elpd)}", "\\makecell[c]{\\textDelta LOO\\\\to best model}", "\\makecell[c]{SE of\\\\\\textDelta LOO}", "\\makecell[c]{LOO\\\\model weight (\\%)}", "\\makecell[c]{Bayesian\\\\$R^2$}"),
             align = rep("c", times = 5))
```

The model with the best out of sample prediction assessed by leave-one-out cross validation was the model fit using the smallest neighborhood size for the variability of forest structure (standard deviation of neighborhood NDVI), the mean of neighborhood NDVI, and the terrain roughness (standard deviation of elevation) `r table_nums(name = "table-ic-table", display = "cite")`

## Effects of prefire vegetation density, 100-hour fuel moisture, potential annual heat load, and topographic roughness on wildfire severity

```{r, results = "hide"}
fig_nums(name = "fig-main-effects")
```

![The main effects of the covariates having the strongest relationships with the probability of high severity fire. All depicted relationships derive from the model using the 90m x 90m neighborhood size window for neighborhood standard deviation of NDVI, neighborhood mean of NDVI, and topographic roughness, as this was the best performing model of the four neighborhood sizes tested. The effect sizes of these covariates were similar for each neighborhood size tested.](../figures/prob-hi-sev-main-effects-credible-intervals.pdf)

We report the results from fitting the model described in `r eq_nums(name = "eq-severity-model", display = "cite")` using the smallest neighborhood size (90m x 90m) because this was the best performing model (see above) and because the size and magnitude of estimated coefficients were similar across neighborhood sizes (Supp. Table 2).

We found that the strongest influence on the probability of a forested area burning at high severity was the density of the vegetation, as measured by the prefire NDVI at that central pixel. A greater prefire NDVI led to a greater probability of high severity fire ($\beta_{\text{prefire\_ndvi}}=$ `r round(ci_betas %>% filter(param == "b_preFire_ndvi" & radius == 1) %>% select(mean) %>% pull(), 3)`; 95% CI: [`r paste(as.character(round(ci_betas %>% filter(param == "b_preFire_ndvi" & radius == 1) %>% select(lwr, upr), 3)), collapse = ", ")`]); `r fig_nums(name = "fig-main-effects", display = "cite")`). There was a strong negative relationship between 100 hour fuel moisture and wildfire severity such that increasing 100-hour fuel moisture was associated with a reduction in the probability of a high severity wildfire ($\beta_{\text{fm100}}=$ `r round(ci_betas %>% filter(param == "b_fm100" & radius == 1) %>% select(mean) %>% pull(), 3)`; 95% CI: [`r paste(as.character(round(ci_betas %>% filter(param == "b_fm100" & radius == 1) %>% select(lwr, upr), 3)), collapse = ", ")`]) (`r fig_nums(name = "fig-main-effects", display = "cite")`). Potential annual heat load, which integrates aspect, slope, and latitude, also had a strong positive relationship with the probability of a high severity fire. Areas that were located on southwest facing sloped terrain at lower latitudes had the highest potential annual heat load, and they were more likely to burn at high severity ($\beta_{\text{pahl}}=$ `r round(ci_betas %>% filter(param == "b_pahl" & radius == 1) %>% select(mean) %>% pull(), 3)`; 95% CI: [`r paste(as.character(round(ci_betas %>% filter(param == "b_pahl" & radius == 1) %>% select(lwr, upr), 3)), collapse = ", ")`]) `r fig_nums(name = "fig-main-effects", display = "cite")`). We found no effect of local topographic roughness on wildfire severity ($\beta_{\text{topographic\_roughness}}=$ `r round(ci_betas %>% filter(param == "b_topo_roughness" & radius == 1) %>% select(mean) %>% pull(), 3)`; 95% CI: [`r paste(as.character(round(ci_betas %>% filter(param == "b_topo_roughness" & radius == 1) %>% select(lwr, upr), 3)), collapse = ", ")`]). We found a negative effect of the prefire neighborhood mean NDVI on the probability of a pixel burning at high severity ($\beta_{\text{nbhd\_mean\_NDVI}}=$ `r round(ci_betas %>% filter(param == "b_neighborhood_mean" & radius == 1) %>% select(mean) %>% pull(), 3)`; 95% CI: [`r paste(as.character(round(ci_betas %>% filter(param == "b_neighborhood_mean" & radius == 1) %>% select(lwr, upr), 3)), collapse = ", ")`]). This is in contrast to the positive effect of the prefire NDVI of the pixel itself. 

There was also a strong negative interaction between the neighborhood mean NDVI and the prefire NDVI of the central pixel ($\beta_{\text{nbhd\_mean\_NDVI*prefire\_NDVI}}$ `r round(ci_betas %>% filter(param == "b_neighborhood_mean_ndvi.preFire_ndvi" & radius == 1) %>% select(mean) %>% pull(), 3)`; 95% CI: [`r paste(as.character(round(ci_betas %>% filter(param == "b_neighborhood_mean_ndvi.preFire_ndvi" & radius == 1) %>% select(lwr, upr), 3)), collapse = ", ")`]). 

### Effect of variability of vegetation structure on wildfire severity

We found strong evidence for a negative effect of variability of vegetation structure on the probability of a high severity wildfire ($\beta_{\text{nbhd\_stdev\_NDVI}}=$ `r round(ci_betas %>% filter(param == "b_het" & radius == 1) %>% dplyr::select(mean) %>% pull(), 3)`; 95% CI: [`r paste(as.character(round(ci_betas %>% filter(param == "b_het" & radius == 1) %>% dplyr::select(lwr, upr), 3)), collapse = ", ")`]); `r fig_nums(name = "fig-main-effects", display = "cite")`). We also found significant interactions between variability of vegetation structure and prefire NDVI $\beta_{\text{nbhd\_stdev\_NDVI*prefire\_NDVI}}=$ `r round(ci_betas %>% filter(param == "b_het_ndvi.preFire_ndvi" & radius == 1) %>% dplyr::select(mean) %>% pull(), 3)`; 95% CI: [`r paste(as.character(round(ci_betas %>% filter(param == "b_het_ndvi.preFire_ndvi" & radius == 1) %>% dplyr::select(lwr, upr), 3)), collapse = ", ")`]); `r fig_nums(name = "fig-main-effects", display = "cite")`) as well as between variability of vegetation structure and neighborhood mean NDVI ($\beta_{\text{nbhd\_stdev\_NDVI*nbhd\_mean\_NDVI}}=$ `r round(ci_betas %>% filter(param == "b_het_ndvi.neighborhood_mean_ndvi" & radius == 1) %>% dplyr::select(mean) %>% pull(), 3)`; 95% CI: [`r paste(as.character(round(ci_betas %>% filter(param == "b_het_ndvi.neighborhood_mean_ndvi" & radius == 1) %>% dplyr::select(lwr, upr), 3)), collapse = ", ")`]); `r fig_nums(name = "fig-main-effects", display = "cite")`).

# Discussion

## A new approach to remotely sensing wildfire severity

We developed a new approach to calculating wildfire severity using remotely sensed images from the Landsat series of satellites using a minimal amount of user input-- a geometry (e.g., a point location of a field plot or a fire perimeter polygon) and a fire start date. We found that the relative burn ratio (RBR) calculated using prefire Landsat images collected over a 48 day period prior to the fire and postfire Landsat images collected over a 48 day period one year after the prefire images validated the best with ground based severity measurements (composite burn index; CBI). 

Interpolation is a well-recognized technique to improve the comparability of remotely sensed imagery to ground-based, fine-scale measurments. It is unlikely that a ground measurement occurs exactly at the center of a pixel, so borrowing information from neighboring pixels improves the representativeness of remotely sensed data to ground data [@Cansler2012]. Bilinear interpolation, which averages the 4 nearest pixels, is often used but we found that bicubic interpolation, which averages the nearest 16 pixels, performs slightly better. Bicubic interpolation is more computationally intensive, but may be preferable when computational power isn't limiting.

Most efforts to calculate severity from satellite data rely on hand curation of a single prefire and a single postfire image [@Miller2007; @Miller2009a; @DeSantis2010; @Cansler2012; @Veraverbeke2013; @Parks2014; @Prichard2014; @Edwards2018; @Fernandez2018]. Recently, @Parks2018 found that using a composite of several prefire images and several postfire images to detect fire impacts performed at least as well as using a single pre- and post-fire image, which also facilitated automated image fetching. @Parks2018 used 3- to 4-month windows during pre-specified times of the year (depending on the fire's region) to collate pre- and postfire imagery one year before the fire and one year after. In contrast, we tested multiple time window lengths based on the fire start date regardless of when it burned during the year. Basing our pre- and postfire image fetching on fixed lengths of time since the fire start date standardized the amount of time elapsed in each severity assessment. Our best remotely sensed severity configuration used a much shorter time window compared to @Parks2018 (48 days versus 3 to 4 months), which likely balanced an incorporation of enough imagery to be representative of the pre- and post-fire vegetation conditions but not so many images that different phenological conditions across the time window added noise to each composite. 

Many algorithms have been developed to measure fire effects on vegetation in an attempt to better correspond to field data [@Key2006; @Miller2007; @Parks2014]. We found that several other remotely sensed measures of severity, including one based on NDVI that is rarely deployed, validated nearly as well with CBI data as the best configuration (the Relative Burn Ratio). We echo the conclusion of @Zhu2006 that the validation of differences between pre- and postfire NDVI to field measured severity data, which uses near infrared reflectance, is comparable to validation using more commonly used severity metrics (e.g., RdNBR and RBR) that rely on short wave infrared reflectance. One immediately operational implication of this is that the increasing availability of low-cost small unhumanned aerial systems (sUAS a.k.a. drones) and near infrared detecting imagers (e.g., those used for agriculture monitoring) may be used to reliably measure wildfire severity at very high spatial resolutions.

## Factors influencing the probability of high severity wildfire

We used our new approach to calculate wildfire severity for `r total_conifer_fires` fires that burned in the Sierra Nevada yellow pine/mixed-conifer forest between 1984 and 2017, creating the most comprehensive dataset of wildfire severity in the Sierra Nevada. We additionally calculated prefire vegetation density, 100-hour fuel moisture, potential annual heat load, local topographic roughness, and the local variability of prefire vegetation density at 4 neighborhood sizes ranging from 0.81 hectares to 7.29 hectares. We modeled the effect of these variables on the probability of a high severity wildfire and found a strong positive effect of both prefire vegetation density and potential annual heat load as well as a strong negative effect of 100 hour fuel moisture, which corroborates similar studies [@Parks2018b]. We found no effect of topographic roughness on wildfire severity. We found a strong negative effect of variability of vegetation structure on wildfire severity, approximately equal to the magnitude of the effect of the potential annual heat load.

## Correlation between covariates and interactions

The Spearman's rank correlation between prefire NDVI and neighborhood mean NDVI was very high ($\text{Spearman's }\rho=$ = `r round(preFire_ndvi.neighborhood_mean_NDVI_correlation, 3)`), though including this interaction in the model described in `r eq_nums(name = "eq-severity-model", display = "cite")` dramatically increased the model's predictive capacity (nested model comparisons not shown). The high correlation between the covariates affects our real-world interpretation of our coefficient estimates. 

We found a strong interaction between the prefire NDVI at a pixel and its neighborhood mean NDVI. The interaction decreases the overall probability of high severity wildfire when these two variables are correlated, effectively dampening the dominating effect of prefire NDVI. That is: if both the prefire NDVI and the prefire neighborhood NDVI increase, the probability of high severity fire doesn't increase quite as much as expected from the additive effect of these two covariates alone and conversely, if both the prefire NDVI and the prefire neighborhood NDVI decrease, the probability of high severity fire doesn't decrease quite as much as expected from the additive effects of these variables alone. Thus, though the relative effect of prefire NDVI on the probability of high severity fire is still positive and large, its real-world effect might be more comparable to other modeled covariates when including the negative main effect of neighborhood mean NDVI and the negative interaction effect of prefire NDVI and neighborhood mean NDVI ($\beta_{\text{prefire\_ndvi}}+\beta_{\text{nbhd\_mean\_NDVI}}+\beta_{\text{nbhd\_mean\_NDVI*prefire\_NDVI}}=$ `r round(ci_betas %>% filter(param == "b_preFire_ndvi" & radius == 1) %>% dplyr::select(mean) %>% pull() + ci_betas %>% filter(param == "b_neighborhood_mean" & radius == 1) %>% dplyr::select(mean) %>% pull() + ci_betas %>% filter(param == "b_neighborhood_mean_ndvi.preFire_ndvi" & radius == 1) %>% dplyr::select(mean) %>% pull(), 3)`). When these covariates are correlated, the effect of vegetation density (including the central pixel and the neighborhood) becomes the second strongest effect on the probability of high severity wildfire, behind the 100-hour fuel moisture.

When prefire NDVI and the neighborhood mean NDVI are decoupled, there is an overall effect of increasing the probability of high severity fire. When prefire NDVI at the central pixel is high and the neighborhood NDVI is low (e.g., an isolated vegetation patch), the probability of high severity fire is expected to dramatically increase. When prefire NDVI at the central pixel is low and the neighborhood NDVI is high (e.g., a hole in the center of an otherwise dense forest), the probability of high severity fire at that central pixel is still expected to be fairly high even though there is limited vegetation density there. When these variables do decouple, they tend to do so in the "hole in the forest" case as described above and lead to a greater probability of high severity fire at the central pixel despite there being limited vegetation density. This can perhaps be explained if the consistently high vegetation density in a local neighborhood-- itself more likely to burn at high severity-- exerts a contagious effect on the central pixel, raising its probability of burning at high severity regardless of how much fuel might be there to burn. Another possibility is that the scenarios with decoupled prefire NDVI and neighborhood mean NDVI are symptoms of a particular combination of vegetation types, such as high shrub cover, which are prone to burning at high severity [@Thompson2009].

We also found interactions of equal and opposite direction between forest strucutral variability and prefire NDVI and between forest structural variability and neighborhood mean NDVI. Thus, when the prefire NDVI and neighborhood mean NDVI are correlated (as they typically are), these contrasting interaction effects cancel each other out. In the more frequent "hole in the forest" scenario when the variables do decouple, the negative effect of local forest variability on the probability of high severity fire is augmented.

## Feedback between forest structural variability and wildfire severity

The system-wide negative relationship between forest structural variability and wildfire severity that we present closes a feedback loop that makes Sierra Nevada yellow pine/mixed-conifer forests resilient to wildfire. Wildfire that burns with a mixture of low, moderate, and high severity generates variable forest structure [@Malone2018; @Collins2018]. High proportions of high severity wildfire, especially when high severity fire occurs in large, contiguous patches that are uncharacteristic of the system's natural range of variation, are at a higher risk for type conversion to non-forest. [VanWagtendonk2006; @Coppoletta2016; @Stephens2013; @Millar2015; @Safford2017]. In contrast, forests with fire regimes more similar to their natural range of variation are less likely to experience type conversion [@Walker2018]. Thus, the relative proportion of high severity fire compared to lower severity fire in the yellow pine/mixed-conifer system is a key determinant of their long term persistence. For instance, @Miller2017 found that half of the yellow pine/mixed-conifer system would reach an old-growth condition under pre-suppression levels of high severity fire, but that only 13% of the forest would reach old-growth condition under modern, elevated probabilities of high severity fire. 

## Neighborhood size

We found that the effect of a forest patch's neighborhood characteristics on the probability of high severity fire materialized at the smallest neighborhood size that we tested, 90m x 90m. This suggests that the negative effect of variability in vegetation structure on fire severity is a very local phenomenon. This corroborates work by @Graham2004 and @Scholl2010 in finding that reduced ladder fuels and increased spacing between tree clumps reduces the probability and spread of crown fires, which are more likely to lead to tree mortality. At a landscape level, forest treatments that reduced fuel loads and increased structural variability can be effective across broader spatial scales [@Schmidt2008; @Stephens2013a], which may reflect that the scale of the forest variability effect can depend on fire weather conditions [@Lydersen2014].

## Translating resistance to long term persistance

@Franklin1986: Used texture analysis on Landsat (!!) "In forested areas,low standard deviation texture values indicate continuous canopy cover and higher values are associated with areas of discontinuous canopy. The largest texture values occur at abrupt vegetation boundaries, thus enhancing edges"

Texture analysis has been used to measure habitat heterogeneity in ecology, but has only recently gained recognition for its potential to quantify system resilience [@Kefi2014]. Texture measurements can reflect the spatial process by which a system stabilizes [@Kefi2014]. In our case, we measure variability in vegetation structure as a spatial feature that is part of the feedback loop between wildfire disturbance and forest spatial structure; we gain insight into longer-term system dynamics by measuring a signature of the pattern forming process itself. More work is needed to assess the degree to which *changing* spatial features of yellow pine/mixed-conifer forests-- or the spatial features of the wildfire disturbance that affect them-- may capture the precariousness of a system to a state change (e.g., to a non-forested system) or an erosion of the underlying feedbacks that make a system resilient.

## Caveats

Our approach to remotely measure wildfire severity should work best in denser vegetation such as forests, as the signal of a wildfire in other systems can be invisible in a matter of weeks [@Goodwin2014]. This method would also require calibration with field data in other systems, as some severity metrics (such as RBR and RdNBR) have found limited success in other regions [@Fernandez2018].

Our 100-hour fuel moisture measurement captures regional climate conditions on the scale of 4km and across several days, but it misses local weather phenomena such as strong wind events and plume-dominated fire behavior which can greatly influence wildfire severity [@Lydersen2014; @Lydersen2017].

We have captured a coarse measure of forest structural variability. The grain size of our measurement was constrained to the 30m x 30m pixel size of Landast satellite imagery, and the minimum spatial extent of a local vegetation neighborhood that we could capture was 90m x 90m. While we did find that this coarse measure does strongly relate to the probability of high severity fire, it does not account for fire behavior or spatial pattern forming processes at the individual tree scale. Due to the correlation of NDVI with vegetation density and the spatial constraints on our measurement of forest structural variability as the standard deviation of neighborhood NDVI, we are most likely capturing "intermediate" scales of forest heterogeneity such as the presence and absence of canopy gaps greater than 30m [@Dickinson2014]. Our approach may prove useful at finer scales using different sets of remotely sensed data (e.g., National Agriculture Imagery Program, Sentinel-2), but at a cost of temporal scale [@Dickinson2016]. Additional metrics of variability such as vegetation patch size distributions or non-vegetated gap size distributions [@Malone2018], may also be more tractable using imagery with a finer spatial resolution. 


## Conclusions 

Cloud-based GIS, central image hosting, and integration with powerful classification tools will advance our ability to measure wildfire severity remotely, automatically, consistently, and at broad spatial scales. While our contribution here demonstrates that satisfactory validation with ground based measurements is possible using simple and well known calculations, we believe that truly groundbreaking abilities to classify wildfire severity would be possible with more open sharing of ground based severity measures. We encourage researchers and managers to make their ground based severity data available with site location (including datum) and the alarm data for the fire the field data is measuring. 

While the severity of a wildfire in any given place may be idiosyncratic and controlled by many variables, we have presented strong evidence that variable forest structure generally makes yellow pine/mixed-conifer forest in the Sierra Nevada more resistant to this inevitable disturbance. Frequent, low-severity wildfire maintains forest structural variability, and we demonstrate a system-wide reciprocal effect suggesting that greater local variability of vegetation structure makes yellow pine/mixed-conifer forest more resilient to wildfire and may increase the probability of its long-term persistence.





