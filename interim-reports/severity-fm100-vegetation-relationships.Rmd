---
title: "Severity, fuel moisture, vegetation relationships"
author: "Michael Koontz"
date: "1/15/2018"
output: html_document
---

```{r setup, echo= FALSE}
library(sf)
library(tidyverse)
library(lme4)
```

```{r load_fire_sample_data, echo= FALSE, cache= TRUE}
data <- st_read("../data/fire_samples/fires-strat-samples_1-month-window_L5_bicubic-interp.geojson")
sn <- st_read("../data/features/SierraEcoregion_Jepson/SierraEcoregion_Jepson.shp") %>% st_transform(4326)
```

# Basic exploratory data analysis

```{r eda}
dim(data)
glimpse(data)
```

# How many unique fires?

```{r how_many_fires}
data$fire_id <- substr(as.character(data$id), start = 1, stop = 20)

# 1503 fires represented from the FRAP database with Landsat 5 imagery that can be processed
length(unique(data$fire_id))
```

# Basic plot of geometry 

```{r basic_plot, cache= TRUE}
plot(data$geometry[data$conifer_forest == 1], pch = 19)
plot(sn$geometry, add = TRUE)
```

# Adjust variables
## Some variables need deriving, and some need adjusting to put on an appropriate scale (e.g., circular variables)

```{r adjust_vars}
## Topography variables
# Adjust aspect to reflect "heat load index" (McCune and Keon, 2002) with southwest having a value of 1, and northeast having a value of -1
circular_aspect <- function(aspect) {
  
  new_aspect <- ((-1 * (aspect)) * pi / 180) - (3/4 * pi)
  return(cos(new_aspect))
  
}

data$c_aspect <- circular_aspect(data$aspect)

# Calculate predicted potential annual direct incident radiation (also from McCune and Keon, 2002)
# which combines slope, aspect, and latitude

fold_aspect <- function(asp) {
  
  rad <- asp * pi / 180
  folded_aspect <- pi - abs(rad - pi)
  return(folded_aspect)
  
}

data$folded_aspect <- fold_aspect(data$aspect)

# G column: latitude
# H column: slope
# I column: folded aspect

# Potential 
pdir <- function(lat, slope, folded_asp) {
  lat <- lat * pi / 180
  slope <- slope * pi / 180
  exp(-1.467 + 1.582 * cos(lat) * cos(slope) - 1.5 * cos(folded_asp) * sin(slope) * sin(lat) - 0.262 * sin(lat) * sin(slope) + 0.607 * sin(folded_asp) * sin(slope))
}

data$pdir <- pdir(data$lat, data$slope, data$folded_aspect)

topo_vars <- c("c_aspect", "pdir", "elev", "lat", "lon", "slope", "topo_roughness_1", "topo_roughness_2", "topo_roughness_3", "topo_roughness_4")

## Timing variables
# Adjust ordinal day to reflect "middle of summer-ness" with August 6th (the 218th day of the year) getting 
# a 1 and February 4th (the 35th day of the year) getting a value of -1
circular_doy <- function(doy) {
  
  new_doy <- ((doy - 218) / 365) * 2 * pi
  return(cos(new_doy))
  
}

data$c_doy <- circular_doy(data$ordinal_day)

# Make year an integer
data$year_ <- as.numeric(as.character(data$year_))

timing_vars <- c("year_", "alarm_date", "cont_date", "c_doy")

## Vegetation variables
veg_vars <- c("focal_mean_evi_1", "focal_mean_evi_2", "focal_mean_evi_3", "focal_mean_evi_4", 
              "focal_mean_ndvi_1", "focal_mean_ndvi_2", "focal_mean_ndvi_3", "focal_mean_ndvi_4",
              "focal_mean_ndwi_1", "focal_mean_ndwi_2", "focal_mean_ndwi_3", "focal_mean_ndwi_4", 
              "het_evi_1", "het_evi_2", "het_evi_3", "het_evi_4", 
              "het_ndvi_1", "het_ndvi_2", "het_ndvi_3", "het_ndvi_4",
              "het_ndwi_1", "het_ndwi_2", "het_ndwi_3", "het_ndwi_4", 
              "preFire_evi",
              "preFire_ndvi",
              "preFire_ndwi")

## Fire weather variables
fireWeather_vars <- c("erc", "fm100", "tmmx")

## All vars to scale
all_vars <- c(topo_vars, timing_vars, veg_vars, fireWeather_vars)
```

## Rescale predictor variables

This should enhance model fitting.

```{r scale_predictor_variables}
# Just focus on the points from the mixed conifer/yellow pine forest
mixed_con <- 
  data %>%
  filter(conifer_forest == 1)

ss <-
  mixed_con %>%
  mutate_at(.vars = all_vars, .funs = funs(s = as.numeric(scale(.))))
```

# Switch to binomial response (high severity vs. not)
From the CBI calibration, we know that the 1-month window, bicubic interpolation of RBR
is a "high severity" pixel when RBR > 0.2836425; Note that "high severity" is
equivalent to "stand replacing"

Many (all?) researchers use the categorical response because remotely-sensed severity
metrics tend to have a non-linear relationship with on-the-ground severity

Our modeling effort then becomes a generalized linear model with a logit link, estimating
how different covariate affect the *probability* of a high severity fire

```{r binomial_response}
ss$stand_replacing <- ifelse(ss$RBR > 0.2836425, yes = 1, no = 0)
```

# Ultimate goal
The theory that we'd **really** like to test is that heterogeneity matters under some fuel/weather conditions, but is overwhelmed by extreme conditions.

## Exploratory plots

### If there's a ton of fuel (i.e., high greenness), how does that affect heterogeneity?

Here are some important interacters with heterogeneity. Just a check here: neighborhood windows with very low and very high mean values of greenness should have low heterogeneity. Heterogeneity requires variation, and there can't be variation at the extreme
values of mean neighborhood greeness.

This plot is beautifully concave down:

```{r het_v_mean, cache= TRUE}
ggplot(ss, aes(x = focal_mean_ndvi_1, y = het_ndvi_1)) +
  geom_point() + 
  geom_smooth(method = "loess")
```

We expect that low and high mean neighborhood values of greeness (e.g., NDVI) should result in low heterogeneity. Heterogeneity requires variation, so if all nearby pixels are low or high in NDVI, then no variation is possible. BUT, we also find that high greeness pixels tend to be around more high greenness pixels. So we just don't get heterogeneity in places where the focal pixel is very green. You don't get a scenario where there is a dense patch of trees, and heterogeneous forest nearby. 

This plot is fairly flat until a point, then it declines quickly:

```{r het_v_focal_mean, cache= TRUE}
ggplot(ss, aes(x = preFire_ndvi, y = het_ndvi_1)) +
  geom_point() +
  geom_smooth(method = "loess")
```

# Designating extreme conditions

From @Stephens2013a, we find that the 80th, 90th, and 97.5th percentile 100-hour fuel moisture conditions are 7.7%, 6.6%, and 4.2%

```{r extreme_conditions}
ss$extreme80_fm100 <- ifelse(ss$fm100 < 7.7, yes = 1, no = 0)
ss$extreme90_fm100 <- ifelse(ss$fm100 < 6.6, yes = 1, no = 0)
ss$extreme97.5_fm100 <- ifelse(ss$fm100 < 4.2, yes = 1, no = 0)
```

Trying to think about whether it makes more sense to include the fm100_s value in the model if I already have "extreme fm100 or not" in the model

It certainly simplifies things to leave it out (no 3-way interaction).

```{r modeling_extreme_conditions}
fm2 <- glmer(stand_replacing ~  het_ndvi_1_s * extreme80_fm100 + preFire_ndvi_s + topo_roughness_1_s + pdir_s + (1 | fire_id), 
              data = ss, 
              family = "binomial",
              control = glmerControl(optimizer = "bobyqa"))

summary(fm2)

```
```{r modeling_extreme_moisture_and_veg_density}
hist(ss$preFire_ndvi)
quantile(ss$preFire_ndvi, probs = c(0, 0.50, 0.80, 0.90, 0.975))
ss$extreme80_preFire_ndvi <- ifelse(ss$preFire_ndvi > quantile(ss$preFire_ndvi, 0.8), yes = 1, no = 0)

fm3 <- glmer(stand_replacing ~  het_ndvi_1_s * extreme80_fm100 * extreme80_preFire_ndvi + topo_roughness_1_s + pdir_s + (1 | fire_id), 
              data = ss, 
              family = "binomial",
              control = glmerControl(optimizer = "bobyqa"))

summary(fm3)

fm4 <- glmer(stand_replacing ~  het_ndvi_1_s * extreme80_fm100 * preFire_ndvi_s + topo_roughness_1_s + pdir_s + (1 | fire_id), 
              data = ss, 
              family = "binomial",
              control = glmerControl(optimizer = "bobyqa"))

summary(fm4)
```
# Plot focal NDVI vs. neighborhood NDVI

```{r focal_ndvi_v_neighborhood_ndvi, cache = FALSE}
par(mfrow = c(2, 2))
plot(x = ss$preFire_ndvi, y = ss$focal_mean_ndvi_1, pch = 20)
plot(x = ss$preFire_ndvi, y = ss$focal_mean_ndvi_2, pch = 20)
plot(x = ss$preFire_ndvi, y = ss$focal_mean_ndvi_3, pch = 20)
plot(x = ss$preFire_ndvi, y = ss$focal_mean_ndvi_4, pch = 20)
```

